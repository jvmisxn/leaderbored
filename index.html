<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeaderBored - Friendly Competition Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Basic styles */
        body { font-family: 'Inter', sans-serif; }
        a, button, .player-entry { transition: all 0.2s ease-in-out; }

        /* --- Admin visibility control --- */
        .admin-only { display: none; }
        body.admin-logged-in #logout-button { display: inline-flex; }
        body.admin-logged-in td .admin-only { display: inline-flex; gap: 0.5rem; vertical-align: middle; }
        body.admin-logged-in #player-info-modal .admin-only { display: block; }
        body.admin-logged-in .contextual-admin-button-container .admin-only { display: inline-flex; }
        body.admin-logged-in .public-only { display: none; }
        /* --- End Admin visibility control --- */

        /* Modal styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 1.5rem 2rem 2rem 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-width: 95%; width: 550px; max-height: 90vh; overflow-y: auto; position: relative; transform: translateY(-20px) scale(0.98); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0; }
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); opacity: 1; }
        .modal-close-button { position: absolute; top: 0.5rem; right: 0.75rem; background: none; border: none; font-size: 1.75rem; font-weight: bold; color: #6b7280; cursor: pointer; padding: 0.25rem; line-height: 1; }
        .modal-close-button:hover { color: #1f2937; }

        /* Ranking table visibility */
        .ranking-table { display: none; }
        .ranking-table.active { display: block; }

        /* Multi-select styling (if used) */
        .multi-select-list { max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; background-color: #f9fafb; }

        /* Table cell padding and wrapping */
        td, th { white-space: nowrap; padding-left: 1rem; padding-right: 1rem; padding-top: 0.75rem; padding-bottom: 0.75rem; vertical-align: middle; }
        td { white-space: normal; }

        /* Validation */
        .border-red-500 { border-color: #ef4444; }

        /* Player Modal Edit Mode */
        .modal-editing .editable-field { display: none; }
        .modal-editing .editing-field { display: block; }
        .editing-field { display: none; }
        .modal-editing .edit-mode-controls { display: inline-flex; }
        .edit-mode-controls { display: none; }
        .modal-editing .view-mode-controls { display: none; }

    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-cyan-50 text-gray-800">
    <nav class="bg-gradient-to-r from-cyan-600 to-blue-700 text-white p-5 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#home" class="text-3xl font-bold hover:text-blue-100 nav-link" data-target="home-section">üèÜ LeaderBored</a>
            <div class="space-x-5">
                <a href="#home" class="hover:text-blue-100 px-3 py-2 rounded-md text-base font-medium nav-link" data-target="home-section">Home</a>
                <a href="#rankings" class="hover:text-blue-100 px-3 py-2 rounded-md text-base font-medium nav-link" data-target="rankings-section">Rankings</a>
                <a href="#results" class="hover:text-blue-100 px-3 py-2 rounded-md text-base font-medium nav-link" data-target="results-section">Results</a>
                <a href="#players" class="hover:text-blue-100 px-3 py-2 rounded-md text-base font-medium nav-link" data-target="players-section">Players</a>
                <a href="#tournaments" class="hover:text-blue-100 px-3 py-2 rounded-md text-base font-medium nav-link" data-target="tournaments-section">Tournaments</a>
                <a href="#login" id="login-link" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium public-only nav-link shadow hover:shadow-md" data-target="login-section">Admin Login</a>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium admin-only shadow hover:shadow-md">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-8 p-6">
        <section id="home-section" class="page-section space-y-8">
             <h1 class="text-4xl font-bold text-gray-900 border-b-2 border-blue-200 pb-3 mb-6">Dashboard</h1>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                 <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300">
                     <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Recent Games</h2>
                     <ul id="recent-games-list" class="space-y-4 text-base">
                         <li class="text-gray-500">Loading recent games...</li>
                     </ul>
                     <a href="#results" class="text-blue-600 hover:underline mt-5 inline-block font-medium nav-link" data-target="results-section">View all results...</a>
                 </div>
                 <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300">
                     <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Top Players (Overall)</h2>
                     <ol id="top-players-list" class="list-decimal list-inside space-y-3 text-base">
                         <li class="text-gray-500">Loading rankings...</li>
                     </ol>
                     <a href="#rankings" class="text-blue-600 hover:underline mt-5 inline-block font-medium nav-link" data-target="rankings-section">View full rankings...</a>
                 </div>
                 <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300">
                     <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Top Teams (Overall)</h2>
                     <ol id="top-teams-list" class="list-decimal list-inside space-y-3 text-base">
                         <li class="text-gray-500">Loading rankings...</li>
                     </ol>
                     <a href="#rankings" class="text-blue-600 hover:underline mt-5 inline-block font-medium nav-link" data-target="rankings-section">View full rankings...</a>
                 </div>
                 <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 md:col-span-2 lg:col-span-1">
                     <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Tournaments</h2>
                     <ul id="dashboard-tournaments-list" class="space-y-4">
                         <li class="text-gray-500">Loading tournaments...</li>
                     </ul>
                     <a href="#tournaments" class="text-blue-600 hover:underline mt-5 inline-block font-medium nav-link" data-target="tournaments-section">View all tournaments...</a>
                 </div>
             </div>
        </section>

        <section id="rankings-section" class="page-section hidden space-y-8">
             <div class="flex justify-between items-center border-b-2 border-blue-200 pb-3 mb-6 flex-wrap gap-4"> <h1 class="text-4xl font-bold text-gray-900">Rankings</h1>
                 <div class="flex items-center gap-4 flex-wrap"> <div>
                         <label for="rankings-game-filter" class="text-sm font-medium text-gray-700 mr-2">Filter by Game:</label>
                         <select id="rankings-game-filter" name="rankings-game-filter" class="shadow-sm border border-gray-300 rounded-lg py-2 px-3 text-base focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                             <option value="overall">Overall (1v1/2v2)</option>
                             </select>
                     </div>
                     <div class="contextual-admin-button-container">
                         <button id="open-add-game-modal-btn" class="admin-only bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 text-sm">
                             ‚öôÔ∏è Add New Game Type
                         </button>
                     </div>
                 </div>
             </div>
             <div id="ranking-tables-container">
                 <div id="ranking-table-overall" class="ranking-table active grid grid-cols-1 md:grid-cols-2 gap-8">
                     <div class="bg-white p-8 rounded-xl shadow-lg">
                         <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Overall 1v1 Rankings (Elo)</h2>
                         <table class="w-full text-left table-auto text-base">
                             <thead> <tr class="bg-gray-100"> <th class="px-4 py-3">Rank</th> <th class="px-4 py-3">Player</th> <th class="px-4 py-3">Rating</th> </tr> </thead>
                             <tbody id="overall-1v1-rankings-body"> <tr class="border-b"><td colspan="3" class="text-center text-gray-500 py-4">Loading...</td></tr> </tbody>
                         </table>
                     </div>
                     <div class="bg-white p-8 rounded-xl shadow-lg">
                         <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Overall 2v2 Team Rankings (Elo)</h2>
                         <table class="w-full text-left table-auto text-base">
                             <thead> <tr class="bg-gray-100"> <th class="px-4 py-3">Rank</th> <th class="px-4 py-3">Team</th> <th class="px-4 py-3">Rating</th> </tr> </thead>
                             <tbody id="overall-2v2-rankings-body"> <tr class="border-b"><td colspan="3" class="text-center text-gray-500 py-4">Loading...</td></tr> </tbody>
                         </table>
                     </div>
                 </div>
                 <div id="ranking-table-pool" class="ranking-table hidden"> <div class="bg-white p-8 rounded-xl shadow-lg">
                         <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Pool Rankings (Elo)</h2>
                         <table class="w-full text-left table-auto text-base">
                             <thead> <tr class="bg-gray-100"> <th class="px-4 py-3">Rank</th> <th class="px-4 py-3">Player</th> <th class="px-4 py-3">Rating</th> </tr> </thead>
                             <tbody id="pool-rankings-body"> <tr class="border-b"><td colspan="3" class="text-center text-gray-500 py-4">Loading...</td></tr> </tbody>
                         </table>
                     </div>
                 </div>
                 <div id="ranking-table-puttpong" class="ranking-table hidden"> <div class="bg-white p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-semibold mb-5 text-indigo-700">PuttPong Rankings (Elo)</h2><table class="w-full text-left table-auto text-base"><thead><tr class="bg-gray-100"><th class="px-4 py-3">Rank</th><th class="px-4 py-3">Player</th><th class="px-4 py-3">Rating</th></tr></thead><tbody id="puttpong-rankings-body"><tr><td colspan="3" class="text-center py-4 text-gray-500">Loading...</td></tr></tbody></table></div></div>
                 <div id="ranking-table-cornhole" class="ranking-table hidden"> <div class="bg-white p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-semibold mb-5 text-indigo-700">Cornhole Rankings (Elo)</h2><table class="w-full text-left table-auto text-base"><thead><tr class="bg-gray-100"><th class="px-4 py-3">Rank</th><th class="px-4 py-3">Player</th><th class="px-4 py-3">Rating</th></tr></thead><tbody id="cornhole-rankings-body"><tr><td colspan="3" class="text-center py-4 text-gray-500">Loading...</td></tr></tbody></table></div></div>
                 <div id="ranking-table-pickleball" class="ranking-table hidden"> <div class="bg-white p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-semibold mb-5 text-indigo-700">Pickleball Rankings (Elo)</h2><table class="w-full text-left table-auto text-base"><thead><tr class="bg-gray-100"><th class="px-4 py-3">Rank</th><th class="px-4 py-3">Player</th><th class="px-4 py-3">Rating</th></tr></thead><tbody id="pickleball-rankings-body"><tr><td colspan="3" class="text-center py-4 text-gray-500">Loading...</td></tr></tbody></table></div></div>
                 <div id="ranking-table-basketball_horse" class="ranking-table hidden"> <div class="bg-white p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-semibold mb-5 text-indigo-700">Basketball (HORSE) Rankings (Elo)</h2><table class="w-full text-left table-auto text-base"><thead><tr class="bg-gray-100"><th class="px-4 py-3">Rank</th><th class="px-4 py-3">Player</th><th class="px-4 py-3">Rating</th></tr></thead><tbody id="basketball_horse-rankings-body"><tr><td colspan="3" class="text-center py-4 text-gray-500">Loading...</td></tr></tbody></table></div></div>
                 </div>
        </section>

        <section id="results-section" class="page-section hidden space-y-8">
            <div class="flex justify-between items-center border-b-2 border-blue-200 pb-3 mb-6">
                 <h1 class="text-4xl font-bold text-gray-900">All Game Results</h1>
                 <div class="contextual-admin-button-container">
                    <button id="open-record-game-modal-btn" class="admin-only bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                        üèÜ Record Game Result
                    </button>
                 </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                <table class="w-full text-left table-auto text-base">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="px-4 py-3">Date</th>
                            <th class="px-4 py-3">Game Type</th>
                            <th class="px-4 py-3">Description</th>
                            <th class="px-4 py-3">Actions</th> </tr>
                    </thead>
                    <tbody id="results-table-body">
                         <tr><td colspan="4" class="text-gray-500 text-center py-4">Loading results...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="players-section" class="page-section hidden space-y-8">
             <div class="flex justify-between items-center border-b-2 border-blue-200 pb-3 mb-6">
                 <h1 class="text-4xl font-bold text-gray-900">Players</h1>
                 <div class="contextual-admin-button-container">
                     <button id="open-add-player-modal-btn" class="admin-only bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                         ‚ûï Add New Player
                     </button>
                 </div>
             </div>
             <div id="players-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                 <p class="text-gray-500 col-span-full text-center">Loading players...</p>
             </div>
        </section>

        <section id="tournaments-section" class="page-section hidden space-y-8">
             <div class="flex justify-between items-center border-b-2 border-blue-200 pb-3 mb-6">
                 <h1 class="text-4xl font-bold text-gray-900">Tournaments</h1>
                  <div class="contextual-admin-button-container">
                    <button id="open-create-tournament-modal-btn" class="admin-only bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        ‚ûï Create New Tournament
                    </button>
                 </div>
             </div>
             <div class="bg-white p-8 rounded-xl shadow-lg">
                 <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Tournament List</h2>
                 <div id="tournaments-list-full" class="space-y-6">
                     <p class="text-gray-500">Loading tournaments...</p>
                 </div>
             </div>
             </section>

        <section id="tournament-detail-section" class="page-section hidden space-y-8">
             <h1 class="text-4xl font-bold text-gray-900 border-b-2 border-blue-200 pb-3 mb-6">Tournament: <span id="tournament-detail-name">[Tournament Name]</span></h1>
             <div class="bg-white p-8 rounded-xl shadow-lg">
                 <p class="text-lg mb-1"><strong>Game:</strong> <span id="tournament-detail-game">[Game]</span></p>
                 <p class="text-lg mb-1"><strong>Format:</strong> <span id="tournament-detail-format">[Format]</span></p>
                 <p class="text-lg mb-4"><strong>Status:</strong> <span id="tournament-detail-status">[Status]</span></p>
                 <h2 class="text-2xl font-semibold mt-8 mb-5 text-indigo-700">Bracket / Matches / Standings</h2>
                 <div id="tournament-detail-visualization" class="border-2 border-dashed border-gray-300 p-12 text-center text-gray-500 rounded-lg min-h-[250px]"> Tournament Visualization Area <br>(Requires JavaScript library or custom rendering based on format) </div>
                 <div class="admin-only mt-6"> <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50"> Report Match Result </button>
                 </div>
             </div>
        </section>

        <section id="login-section" class="page-section hidden">
             <h1 class="text-4xl font-bold text-gray-900 border-b-2 border-blue-200 pb-3 mb-6 text-center">Admin Login</h1>
             <div class="bg-white p-10 rounded-xl shadow-xl max-w-lg mx-auto">
                 <form id="login-form">
                     <div class="mb-6">
                         <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                         <input type="password" id="password" name="password" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                     </div>
                     <div id="login-error" class="text-red-500 text-sm mb-4 hidden">Incorrect password.</div>
                     <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"> Login </button>
                 </form>
             </div>
        </section>

        </div> <div id="player-info-modal" class="modal-overlay">
        <div class="modal-content">
             <button id="close-player-modal-btn" class="modal-close-button">&times;</button>
             <div class="flex items-start space-x-6 mb-4">
                 <img id="modal-player-icon" src="https://placehold.co/80x80/cccccc/ffffff?text=?" alt="Player Icon" class="w-20 h-20 rounded-full flex-shrink-0 object-cover border-2 border-indigo-200">
                 <div class="flex-grow">
                     <h2 id="modal-player-name" class="text-3xl font-semibold mb-1 editable-field">Player Name</h2>
                     <input type="text" id="modal-edit-player-name-input" class="editing-field shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 text-xl font-semibold mb-1" placeholder="Player Name">
                     <div class="text-sm text-gray-600 mt-1" id="modal-player-overall-stats">
                         Loading stats...
                     </div>
                      <div class="editing-field mt-2">
                          <label for="modal-edit-player-icon-input" class="block text-gray-700 text-sm font-bold mb-1">Icon URL:</label>
                          <input type="url" id="modal-edit-player-icon-input" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/icon.png">
                      </div>
                 </div>
                 <div class="admin-only">
                    <div class="view-mode-controls">
                        <button id="edit-player-modal-btn" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-bold py-2 px-4 rounded-lg text-sm">Edit</button>
                    </div>
                    <div class="edit-mode-controls space-x-2">
                        <button id="save-player-changes-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Save</button>
                        <button id="cancel-player-edit-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                        <button id="delete-player-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm ml-4">Delete Player</button>
                    </div>
                </div>
             </div>
             <div class="mt-4 border-t pt-4">
                 <h3 class="text-xl font-semibold mb-3 text-indigo-600">Game Ratings (Elo)</h3>
                 <div id="modal-player-game-stats" class="text-sm text-gray-700 grid grid-cols-2 gap-x-4 gap-y-1">
                     <p class="text-gray-500 col-span-2">Loading ratings...</p>
                 </div>
             </div>
             <div class="mt-4 border-t pt-4">
                 <h3 class="text-xl font-semibold mb-3 text-indigo-600">Recent Activity</h3>
                 <ul id="modal-player-recent-activity" class="list-disc list-inside space-y-1 text-sm text-gray-700">
                     <li class="text-gray-500">Loading activity...</li>
                 </ul>
             </div>
         </div>
    </div>

    <div id="record-game-modal" class="modal-overlay"></div>
    <div id="add-player-modal" class="modal-overlay"></div>
    <div id="create-tournament-modal" class="modal-overlay"></div>
    <div id="add-game-modal" class="modal-overlay"></div>

    <footer class="text-center text-gray-600 text-base mt-12 mb-6"> &copy; 2025 LeaderBored. Keep it friendly!
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // --- Basic Page Navigation & Admin Simulation ---
        const ADMIN_PASSWORD = "admin";
        const DEFAULT_ELO = 1200; // Default starting Elo
        const K_FACTOR = 32; // Elo K-factor (adjust sensitivity)

        // --- Game Type Configuration (Single Source of Truth) ---
        // Key: used in Firestore (elos.<key>) and element IDs (ranking-table-<key>)
        // Value: Display Name used in dropdowns and headings
        let gameTypesConfig = {
            pool: "Pool",
            puttpong: "PuttPong",
            cornhole: "Cornhole",
            pickleball: "Pickleball",
            basketball_horse: "Basketball (HORSE)"
            // Add other predefined games here
            // New games added by admin will be appended to this object
        };
        // Create a list of keys that use Elo for easy iteration
        let ELO_GAME_KEYS = Object.keys(gameTypesConfig);


        // --- DOM Element References ---
        let sections, navLinks, loginForm, loginError, logoutButton,
            recordGameModal, openRecordGameModalBtn,
            addPlayerModal, openAddPlayerModalBtn,
            createTournamentModal, openCreateTournamentModalBtn,
            addGameModal, openAddGameModalBtn, // New elements for Add Game
            rankingsGameFilter, rankingTablesContainer,
            resultsTableBody,
            playersGrid,
            playerInfoModal,
            manageTournamentsListContainer; // Keep if needed for future management features

        // --- Firebase Initialization ---
        let app, db;
        try {
            const firebaseConfig = {
              apiKey: "AIzaSyCF3az8WEAMVpAx5cbp917EUhNM5cRzvwA",
              authDomain: "leaderbored2.firebaseapp.com",
              projectId: "leaderbored2",
              storageBucket: "leaderbored2.appspot.com",
              messagingSenderId: "449176616925",
              appId: "1:449176616925:web:8149e2e8b43a9a72104034",
              measurementId: "G-8LRFJGV2XY"
            };
            if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                console.error("Firebase config is missing critical values (apiKey or projectId).");
                alert("Firebase configuration is incomplete. Please check the script.");
            } else {
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("[INIT] Firebase Initialized Successfully with Project ID:", firebaseConfig.projectId);
            }
        } catch (error) {
            console.error("[INIT] Error initializing Firebase:", error);
            alert("Could not connect to Firebase. Please check your configuration and console.");
        }

        // --- Assign DOM Elements ---
        function assignElements() {
            sections = document.querySelectorAll('.page-section');
            navLinks = document.querySelectorAll('.nav-link');
            loginForm = document.getElementById('login-form');
            loginError = document.getElementById('login-error');
            logoutButton = document.getElementById('logout-button');
            // Modals and their trigger buttons
            recordGameModal = document.getElementById('record-game-modal');
            openRecordGameModalBtn = document.getElementById('open-record-game-modal-btn');
            addPlayerModal = document.getElementById('add-player-modal');
            openAddPlayerModalBtn = document.getElementById('open-add-player-modal-btn');
            createTournamentModal = document.getElementById('create-tournament-modal');
            openCreateTournamentModalBtn = document.getElementById('open-create-tournament-modal-btn');
            addGameModal = document.getElementById('add-game-modal'); // New
            openAddGameModalBtn = document.getElementById('open-add-game-modal-btn'); // New
            // Other elements
            rankingsGameFilter = document.getElementById('rankings-game-filter');
            rankingTablesContainer = document.getElementById('ranking-tables-container');
            resultsTableBody = document.getElementById('results-table-body');
            playersGrid = document.querySelector('#players-section #players-grid');
            playerInfoModal = document.getElementById('player-info-modal');
            manageTournamentsListContainer = document.getElementById('manage-tournaments-list-container');

            // Add checks
            if (!resultsTableBody) console.error("Critical Error: Results table body (#results-table-body) not found!");
            if (!playersGrid) console.error("Critical Error: Players grid container (#players-grid) not found!");
            if (!openRecordGameModalBtn) console.warn("Record Game button not found.");
            if (!openAddPlayerModalBtn) console.warn("Add Player button not found.");
            if (!openCreateTournamentModalBtn) console.warn("Create Tournament button not found.");
            if (!openAddGameModalBtn) console.warn("Add Game button not found."); // New check
        }


        // --- Utility Functions ---
        // Populates a select dropdown from an object { key: value, ... }
        function populateSelectWithOptions(selectElement, optionsObject, prompt = 'Select...') {
             if (!selectElement) { console.warn("populateSelectWithOptions: Provided selectElement is null or undefined."); return; }
             const currentValue = selectElement.value;
             selectElement.innerHTML = `<option value="">${prompt}</option>`;
             for (const key in optionsObject) {
                 if (Object.hasOwnProperty.call(optionsObject, key)) {
                     const value = optionsObject[key];
                     const optionElement = document.createElement('option');
                     optionElement.value = key; // Use the key as the value
                     optionElement.textContent = value; // Use the value as the display text
                     if (key === currentValue) {
                         optionElement.selected = true;
                     }
                     selectElement.appendChild(optionElement);
                 }
             }
         }

        // --- Dynamic UI Updates ---
        // Updates dropdowns that list game types
        function updateGameTypeDropdowns() {
            console.log("[UI Update] Updating game type dropdowns...");
            const recordGameSelect = document.getElementById('game-type-select-modal'); // In Record Game Modal
            const rankingsFilterSelect = document.getElementById('rankings-game-filter'); // On Rankings Page
            const tournamentGameSelect = document.getElementById('tournament-game-type-select'); // In Create Tournament Modal

            // Add 'overall' option specifically to rankings filter if needed
            const rankingsOptions = { overall: "Overall (1v1/2v2)", ...gameTypesConfig };

            if (recordGameSelect) populateSelectWithOptions(recordGameSelect, gameTypesConfig, 'Select Game Type');
            if (rankingsFilterSelect) populateSelectWithOptions(rankingsFilterSelect, rankingsOptions); // Use combined options
            if (tournamentGameSelect) populateSelectWithOptions(tournamentGameSelect, gameTypesConfig, 'Select Type'); // Populate in create tournament modal
        }

        // --- Page Section Navigation ---
        function showSection(targetId) {
             if (!sections) { console.error("Sections variable is not assigned yet in showSection"); return; }
             console.log(`[NAV] Navigating to: ${targetId}`);
            const cleanTargetId = targetId.startsWith('#') ? targetId.substring(1) : targetId;
            let sectionFound = false;

            sections.forEach(section => {
                if (section && section.id) section.classList.add('hidden');
            });

            const targetSection = document.getElementById(cleanTargetId);
            if (targetSection && targetSection.classList.contains('page-section')) {
                console.log(`[NAV] Showing section: ${targetSection.id}`);
                targetSection.classList.remove('hidden');
                sectionFound = true;

                if (db) {
                    if (cleanTargetId === 'home-section') populateDashboard();
                    if (cleanTargetId === 'rankings-section' && rankingTablesContainer) {
                        updateGameTypeDropdowns(); // Ensure filter is up-to-date
                        updateRankingsVisibility(); // Populate initial view
                    }
                    if (cleanTargetId === 'results-section' && resultsTableBody) populateResultsTable();
                    if (cleanTargetId === 'players-section' && playersGrid) populatePlayersList();
                    if (cleanTargetId === 'tournaments-section' && document.getElementById('tournaments-list-full')) populateTournamentsList('tournaments-list-full');
                } else {
                    console.warn(`[NAV] DB not ready, skipping population for section ${cleanTargetId}`);
                }

            } else {
                 console.warn(`[NAV] Section with ID "${cleanTargetId}" not found or invalid. Showing home.`);
                 const homeSection = document.getElementById('home-section');
                 if (homeSection) {
                     homeSection.classList.remove('hidden');
                     if (db) populateDashboard();
                 } else {
                     console.error("Critical Error: Home section (#home-section) not found as fallback.");
                 }
            }

            if (sectionFound) {
                window.location.hash = cleanTargetId;
                window.scrollTo(0, 0);
            }
        }

        // --- Admin Panel Navigation REMOVED ---


        // --- Player List and Modal Functions (Firestore) ---
        async function populatePlayersList() {
             if (!playersGrid) { console.warn("Player grid container (#players-grid) not found."); return; }
             playersGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center">Loading players...</p>';
             try {
                 if (!db) throw new Error("Firestore database (db) is not initialized.");
                 const snapshot = await db.collection('players').orderBy('name').get();
                 if (snapshot.empty) {
                     playersGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No players found. Add players via Admin Login.</p>';
                     return;
                 }
                 playersGrid.innerHTML = ''; // Clear loading
                 snapshot.forEach(doc => {
                     const player = { id: doc.id, ...doc.data() };
                     const div = document.createElement('div');
                     div.className = 'player-entry bg-white p-5 rounded-lg shadow hover:shadow-md cursor-pointer flex items-center space-x-4 transition duration-200 ease-in-out';
                     div.setAttribute('data-player-id', player.id);
                     const iconUrl = player.iconUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(player.name || '?')}&background=E0E7FF&color=4F46E5&size=48`;
                     div.innerHTML = `
                         <img src="${iconUrl}" alt="Icon ${player.name || ''}" class="w-12 h-12 rounded-full flex-shrink-0 object-cover bg-gray-200" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=?&background=cccccc&color=ffffff&size=48';">
                         <span class="font-medium text-lg text-gray-800 truncate">${player.name || 'Unnamed Player'}</span> `;
                     playersGrid.appendChild(div);
                 });
             } catch (error) {
                 console.error("Error fetching players:", error);
                 playersGrid.innerHTML = `<p class="text-red-500 col-span-full text-center">Error loading players: ${error.message}</p>`;
             }
        }

        async function openPlayerModal(playerId) {
            if (!playerInfoModal || !db) { console.error("Player modal or DB not ready."); return; }
            const modalContent = playerInfoModal.querySelector('.modal-content');
            if (!modalContent) { console.error("Modal content div not found."); return; }

            // Reset fields and show loading
            const nameEl = modalContent.querySelector('#modal-player-name');
            const statsEl = modalContent.querySelector('#modal-player-game-stats');
            const activityEl = modalContent.querySelector('#modal-player-recent-activity');
            const iconEl = modalContent.querySelector('#modal-player-icon');
            const nameInputEl = modalContent.querySelector('#modal-edit-player-name-input');
            const iconInputEl = modalContent.querySelector('#modal-edit-player-icon-input');
            const overallStatsEl = modalContent.querySelector('#modal-player-overall-stats');

            if(nameEl) nameEl.textContent = 'Loading...';
            if(statsEl) statsEl.innerHTML = '<p class="text-gray-500 col-span-2">Loading ratings...</p>';
            if(activityEl) activityEl.innerHTML = '<li class="text-gray-500">Loading activity...</li>';
            if(iconEl) iconEl.src = 'https://placehold.co/80x80/cccccc/ffffff?text=?';
            if(nameInputEl) nameInputEl.value = '';
            if(iconInputEl) iconInputEl.value = '';
            if(overallStatsEl) overallStatsEl.innerHTML = 'Loading stats...';
            playerInfoModal.classList.remove('modal-editing');

            playerInfoModal.classList.add('active');
            document.body.style.overflow = 'hidden';

             try {
                 const playerDocRef = db.collection('players').doc(playerId);
                 const docSnap = await playerDocRef.get();
                 if (!docSnap.exists) throw new Error(`Player document not found for ID: ${playerId}`);

                 const details = { id: docSnap.id, ...docSnap.data() };
                 playerInfoModal.setAttribute('data-current-player-id', playerId);

                 // Populate basic details
                 const iconSrc = details.iconUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(details.name || '?')}&background=E0E7FF&color=4F46E5&size=80`;
                 if(iconEl) { iconEl.src = iconSrc; iconEl.alt = `Icon ${details.name || ''}`; }
                 if(nameEl) nameEl.textContent = details.name || 'Unnamed Player';
                 if(nameInputEl) nameInputEl.value = details.name || '';
                 if(iconInputEl) iconInputEl.value = details.iconUrl || '';

                 // Populate Overall Stats (W/L/D/Played)
                 if (overallStatsEl) {
                     const wins = details.wins || 0;
                     const losses = details.losses || 0;
                     const draws = details.draws || 0;
                     const played = details.games_played || 0;
                     overallStatsEl.innerHTML = `
                        Overall: <span class="font-medium text-green-600">${wins}W</span> /
                        <span class="font-medium text-red-600">${losses}L</span> /
                        <span class="font-medium text-gray-600">${draws}D</span>
                        (${played} Played) | Elo: <span id="modal-player-overall-rating" class="font-medium">${Math.round(details.elo_overall || DEFAULT_ELO)}</span>
                     `;
                 }

                 // Populate game-specific Elos
                 if (statsEl) {
                    statsEl.innerHTML = ''; // Clear loading
                    const elos = details.elos || {};
                    let statsHtml = '';
                    // Iterate through the *current* gameTypesConfig to display known games
                    Object.entries(gameTypesConfig).forEach(([gameKey, gameName]) => {
                        const rating = Math.round(elos[gameKey] || DEFAULT_ELO);
                        statsHtml += `<div class="font-medium text-gray-900">${gameName}:</div><div class="text-indigo-600">${rating}</div>`;
                    });
                    if (!statsHtml) {
                        statsHtml = '<p class="text-gray-500 col-span-2 italic">No specific game ratings found.</p>';
                    }
                    statsEl.innerHTML = statsHtml;
                 }

                 // Populate recent activity (reuse existing function)
                 await populatePlayerRecentActivity(activityEl, playerId, 5);

             } catch (error) {
                  console.error("[PLAYER MODAL] Error:", error);
                  alert(`Error loading player details: ${error.message}`);
                  closePlayerModal();
             }
        }
        function closePlayerModal() {
             if (playerInfoModal) {
                 playerInfoModal.classList.remove('active');
                 playerInfoModal.classList.remove('modal-editing');
                 playerInfoModal.removeAttribute('data-current-player-id');
                 document.body.style.overflow = '';
             }
        }
        // --- Function to populate recent activity in player modal ---
        async function populatePlayerRecentActivity(activityElement, playerId, limit = 5) {
            if (!db || !playerId || !activityElement) return;
            activityElement.innerHTML = '<li class="text-gray-500">Loading activity...</li>';
            console.log(`[ACTIVITY DEBUG] Fetching activity for ${playerId}`);
            try {
                // NOTE: Requires Firestore index: games: participants (Array), date_played (Descending)
                const gamesQuery = db.collection('games')
                                    .where('participants', 'array-contains', playerId)
                                    .orderBy('date_played', 'desc')
                                    .limit(limit);
                const snapshot = await gamesQuery.get();

                if (snapshot.empty) {
                    activityElement.innerHTML = '<li class="text-gray-500">No recent game activity found.</li>';
                    return;
                }
                activityElement.innerHTML = ''; // Clear loading
                console.log(`[ACTIVITY DEBUG] Found ${snapshot.size} activities for ${playerId}.`);

                const playerCacheModal = {};
                const getPlayerNameModal = async (pid) => {
                   if (!pid) return 'N/A';
                   if (playerCacheModal[pid]) return playerCacheModal[pid];
                   try {
                       const playerDoc = await db.collection('players').doc(pid).get();
                       const name = playerDoc.exists ? playerDoc.data().name : 'Unknown';
                       playerCacheModal[pid] = name;
                       return name;
                   } catch (err) { return 'Error'; }
                };

                for (const doc of snapshot.docs) {
                     const game = { id: doc.id, ...doc.data() };
                     let description = "Game played";
                     const gameDate = game.date_played?.toDate ? game.date_played.toDate().toLocaleDateString() : 'Unknown Date';
                     // Use gameTypesConfig for display name, fallback to key
                     const gameType = gameTypesConfig[game.game_type] || game.game_type || 'Unknown Game';

                    const participants = game.participants || [];
                    const participantNames = await Promise.all(participants.map(id => getPlayerNameModal(id)));
                    const currentPlayerName = playerCacheModal[playerId] || await getPlayerNameModal(playerId);

                    if (game.outcome === 'Win/Loss' && participants.length >= 2) {
                        const winnerName = await getPlayerNameModal(participants[0]);
                        const loserName = await getPlayerNameModal(participants[1]);
                         if (winnerName === currentPlayerName) {
                             description = `Beat ${loserName} in ${gameType}`;
                         } else if (loserName === currentPlayerName) {
                             description = `Lost to ${winnerName} in ${gameType}`;
                         } else {
                            description = `${winnerName} beat ${loserName} in ${gameType}`;
                         }
                    } else if (game.outcome === 'Draw' && participants.length >= 2) {
                        const opponentName = participantNames.find(name => name !== currentPlayerName) || 'opponent';
                        description = `Drew against ${opponentName} in ${gameType}`;
                    } else {
                        const otherPlayerNames = participantNames.filter(name => name !== currentPlayerName).join(', ');
                        description = `Played ${gameType}${otherPlayerNames ? ' with ' + otherPlayerNames : ''}`;
                    }
                     if (game.score) description += ` (${game.score})`;

                    const li = document.createElement('li');
                    li.innerHTML = `<span class="text-gray-500 text-xs mr-2">[${gameDate}]</span> ${description}`;
                    activityElement.appendChild(li);
                }
                console.log(`[ACTIVITY DEBUG] Finished populating activity for ${playerId}.`);

            } catch (error) {
                console.error(`Error fetching recent activity for player ${playerId}:`, JSON.stringify(error));
                if (error.code === 'failed-precondition') {
                     activityElement.innerHTML = `<li class="text-red-500">Error: Firestore index required. Please check the console for a link to create it.</li>`;
                     console.error("Firestore requires a composite index for this query. Please create it in the Firebase console. The query involves filtering 'participants' (array-contains) and ordering by 'date_played' (desc).");
                } else {
                    activityElement.innerHTML = `<li class="text-red-500">Error loading activity: ${error.message || JSON.stringify(error)}</li>`;
                }
            }
        }


        // --- Record Game Modal Functions ---
        function openRecordGameModal() {
            if (!recordGameModal || !db) { console.error("Record game modal or DB not ready."); return; }

            const modalContentHTML = `
                <div class="modal-content">
                    <button id="close-record-game-modal-btn" class="modal-close-button">&times;</button>
                    <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Record Game Result</h2>
                    <form id="record-game-form">
                        <div class="mb-4">
                            <label for="game-type-select-modal" class="block text-gray-700 text-sm font-bold mb-2">Game Type:</label>
                            <select id="game-type-select-modal" name="game-type" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700" required>
                                <option value="">Select Game Type</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="winner_player" class="block text-gray-700 text-sm font-bold mb-2">Winner:</label>
                            <select id="winner_player" name="winner_player" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700" required>
                                <option value="">Select Winner</option>
                                </select>
                        </div>
                        <div class="mb-4">
                            <label for="loser_player" class="block text-gray-700 text-sm font-bold mb-2">Loser:</label>
                            <select id="loser_player" name="loser_player" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700" required>
                                <option value="">Select Loser</option>
                                </select>
                        </div>
                        <div class="mb-4">
                            <label for="score" class="block text-gray-700 text-sm font-bold mb-2">Score (Optional):</label>
                            <input type="text" id="score" name="score" placeholder="e.g. 8-3, 21-15" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700">
                        </div>
                        <div class="mb-4">
                             <label class="inline-flex items-center">
                                <input type="checkbox" id="is_draw" name="is_draw" class="form-checkbox h-5 w-5 text-blue-600">
                                <span class="ml-2 text-gray-700">Record as a Draw?</span>
                             </label>
                         </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" id="cancel-record-game-modal-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-5 rounded-lg">Cancel</button>
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg">Record Result</button>
                        </div>
                    </form>
                </div>`;

            recordGameModal.innerHTML = modalContentHTML;

            const closeButton = recordGameModal.querySelector('#close-record-game-modal-btn');
            const cancelButton = recordGameModal.querySelector('#cancel-record-game-modal-btn');
            const modalForm = recordGameModal.querySelector('#record-game-form');
            const drawCheckbox = recordGameModal.querySelector('#is_draw');
            const winnerSelect = recordGameModal.querySelector('#winner_player');
            const loserSelect = recordGameModal.querySelector('#loser_player');
            const winnerLabel = recordGameModal.querySelector('label[for="winner_player"]');
            const loserLabel = recordGameModal.querySelector('label[for="loser_player"]');
            const gameTypeSelect = recordGameModal.querySelector('#game-type-select-modal'); // Get the select element

            if (closeButton) closeButton.addEventListener('click', closeRecordGameModal);
            if (cancelButton) cancelButton.addEventListener('click', closeRecordGameModal);
            if (modalForm) modalForm.addEventListener('submit', handleRecordGameSubmit);

             if(drawCheckbox && winnerLabel && loserLabel && winnerSelect && loserSelect) {
                 drawCheckbox.addEventListener('change', (e) => {
                     const isChecked = e.target.checked;
                     winnerLabel.textContent = isChecked ? 'Player 1:' : 'Winner:';
                     loserLabel.textContent = isChecked ? 'Player 2:' : 'Loser:';
                 });
             }

            // Populate game type dropdown dynamically
            if (gameTypeSelect) {
                populateSelectWithOptions(gameTypeSelect, gameTypesConfig, 'Select Game Type');
            }

            populateRecordGameDropdowns(); // Populate player dropdowns
            recordGameModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeRecordGameModal() {
            if (recordGameModal) {
                recordGameModal.classList.remove('active');
                recordGameModal.innerHTML = '';
                document.body.style.overflow = '';
            }
        }

        // --- Add Player Modal Functions ---
        function openAddPlayerModal() {
            if (!addPlayerModal || !db) { console.error("Add Player modal or DB not ready."); return; }

            const modalContentHTML = `
                <div class="modal-content">
                    <button id="close-add-player-modal-btn" class="modal-close-button">&times;</button>
                    <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Add New Player</h2>
                    <form id="add-player-form">
                        <div class="mb-5">
                            <label for="modal-player-name" class="block text-gray-700 text-sm font-bold mb-2">Player Name:</label>
                            <input type="text" id="modal-player-name" name="player-name" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                         <div class="mb-5">
                            <label for="modal-player-icon-url" class="block text-gray-700 text-sm font-bold mb-2">Icon URL (Optional):</label>
                            <input type="url" id="modal-player-icon-url" name="player-icon-url" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/icon.png">
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" id="cancel-add-player-modal-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-5 rounded-lg">Cancel</button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">Add Player</button>
                        </div>
                    </form>
                </div>`;

            addPlayerModal.innerHTML = modalContentHTML;

            const closeButton = addPlayerModal.querySelector('#close-add-player-modal-btn');
            const cancelButton = addPlayerModal.querySelector('#cancel-add-player-modal-btn');
            const modalForm = addPlayerModal.querySelector('#add-player-form');

            if (closeButton) closeButton.addEventListener('click', closeAddPlayerModal);
            if (cancelButton) cancelButton.addEventListener('click', closeAddPlayerModal);
            if (modalForm) modalForm.addEventListener('submit', handleAddPlayerSubmit);

            addPlayerModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAddPlayerModal() {
             if (addPlayerModal) {
                addPlayerModal.classList.remove('active');
                addPlayerModal.innerHTML = '';
                document.body.style.overflow = '';
            }
        }

        // --- Create Tournament Modal Functions ---
        function openCreateTournamentModal() {
             if (!createTournamentModal || !db) { console.error("Create Tournament modal or DB not ready."); return; }

             const modalContentHTML = `
                <div class="modal-content">
                    <button id="close-create-tournament-modal-btn" class="modal-close-button">&times;</button>
                    <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Create New Tournament</h2>
                    <form id="create-tournament-form">
                         <div class="mb-5"> <label for="tournament-name" class="block text-gray-700 text-sm font-bold mb-2">Tournament Name:</label> <input type="text" id="tournament-name" name="tournament-name" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" required> </div>
                         <div class="mb-5"> <label for="tournament-game-type-select" class="block text-gray-700 text-sm font-bold mb-2">Game Type:</label> <select id="tournament-game-type-select" name="tournament-game-type" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700" required> <option value="">Select Type</option> </select> </div>
                         <div class="mb-5"> <label for="tournament-format" class="block text-gray-700 text-sm font-bold mb-2">Format:</label> <select id="tournament-format" name="tournament-format" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700" required> <option value="">Select Format</option> <option value="single-elim">Single Elimination</option> <option value="double-elim">Double Elimination</option> <option value="round-robin">Round Robin</option> </select> </div>
                         <div class="mb-5"> <label for="tournament-start-date" class="block text-gray-700 text-sm font-bold mb-2">Start Date (Optional):</label> <input type="date" id="tournament-start-date" name="tournament-start-date" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700"> </div>
                         <div class="mb-5"> <label class="block text-gray-700 text-sm font-bold mb-2">Participants:</label> <div id="tournament-participants-list" class="h-40 border rounded-lg p-3 overflow-y-auto bg-gray-50 space-y-2"> <p class="text-gray-500 text-sm">Select Game Type to see participants.</p> </div> <p class="text-xs text-gray-500 mt-1">Select participants. Seeding will be based on current rankings for the selected game type.</p> </div>
                         <div class="mt-6 flex justify-end space-x-3">
                             <button type="button" id="cancel-create-tournament-modal-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-5 rounded-lg">Cancel</button>
                             <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg shadow hover:shadow-md">Create Tournament</button>
                         </div>
                     </form>
                </div>`;

            createTournamentModal.innerHTML = modalContentHTML;

            const closeButton = createTournamentModal.querySelector('#close-create-tournament-modal-btn');
            const cancelButton = createTournamentModal.querySelector('#cancel-create-tournament-modal-btn');
            const modalForm = createTournamentModal.querySelector('#create-tournament-form');
            const gameTypeSelect = modalForm.querySelector('#tournament-game-type-select'); // Get select

            if (closeButton) closeButton.addEventListener('click', closeCreateTournamentModal);
            if (cancelButton) cancelButton.addEventListener('click', closeCreateTournamentModal);
            if (modalForm) {
                modalForm.addEventListener('submit', handleCreateTournamentSubmit);
                if (gameTypeSelect) {
                     // Populate game type dropdown dynamically
                    populateSelectWithOptions(gameTypeSelect, gameTypesConfig, 'Select Type');
                    gameTypeSelect.addEventListener('change', populateTournamentParticipantsSelect);
                }
                populateTournamentParticipantsSelect(); // Initial population attempt
            }

            createTournamentModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCreateTournamentModal() {
            if (createTournamentModal) {
                createTournamentModal.classList.remove('active');
                createTournamentModal.innerHTML = '';
                document.body.style.overflow = '';
            }
        }

        // --- Add Game Modal Functions (NEW) ---
        function openAddGameModal() {
            if (!addGameModal) { console.error("Add Game modal element not found."); return; }

            const modalContentHTML = `
                <div class="modal-content">
                    <button id="close-add-game-modal-btn" class="modal-close-button">&times;</button>
                    <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Add New Game Type</h2>
                    <form id="add-game-form">
                        <div class="mb-4">
                            <label for="new-game-key" class="block text-gray-700 text-sm font-bold mb-2">Game Key:</label>
                            <input type="text" id="new-game-key" name="new-game-key" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required pattern="[a-z0-9_]+" placeholder="e.g. foosball, table_tennis (lowercase, underscores)">
                            <p class="text-xs text-gray-500 mt-1">Use lowercase letters, numbers, and underscores only. This is used internally.</p>
                        </div>
                         <div class="mb-5">
                            <label for="new-game-name" class="block text-gray-700 text-sm font-bold mb-2">Display Name:</label>
                            <input type="text" id="new-game-name" name="new-game-name" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="e.g. Foosball, Table Tennis">
                             <p class="text-xs text-gray-500 mt-1">This name appears in dropdowns and headings.</p>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" id="cancel-add-game-modal-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-5 rounded-lg">Cancel</button>
                            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg">Add Game</button>
                        </div>
                    </form>
                </div>`;

            addGameModal.innerHTML = modalContentHTML;

            const closeButton = addGameModal.querySelector('#close-add-game-modal-btn');
            const cancelButton = addGameModal.querySelector('#cancel-add-game-modal-btn');
            const modalForm = addGameModal.querySelector('#add-game-form');

            if (closeButton) closeButton.addEventListener('click', closeAddGameModal);
            if (cancelButton) cancelButton.addEventListener('click', closeAddGameModal);
            if (modalForm) modalForm.addEventListener('submit', handleAddGameSubmit);

            addGameModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAddGameModal() {
             if (addGameModal) {
                addGameModal.classList.remove('active');
                addGameModal.innerHTML = '';
                document.body.style.overflow = '';
            }
        }


        // --- Populate Dropdowns from Firestore ---
        async function populateRecordGameDropdowns() {
            const winnerSelect = document.getElementById('winner_player');
            const loserSelect = document.getElementById('loser_player');
            if (!winnerSelect || !loserSelect || !db) {
                console.error("Cannot populate record game dropdowns (elements or DB missing).");
                return;
            }
            winnerSelect.innerHTML = '<option value="">Select Winner</option>'; // Reset
            loserSelect.innerHTML = '<option value="">Select Loser</option>'; // Reset
            try {
                const snapshot = await db.collection('players').orderBy('name').get();
                if (snapshot.empty) return; // No players to add
                snapshot.forEach(doc => {
                    const player = { id: doc.id, ...doc.data() };
                    const optionHTML = `<option value="${player.id}">${player.name || 'Unnamed Player'}</option>`;
                    winnerSelect.insertAdjacentHTML('beforeend', optionHTML);
                    loserSelect.insertAdjacentHTML('beforeend', optionHTML);
                });
            } catch (error) {
                console.error("Error fetching players for record game dropdowns:", error);
                alert(`Error loading players: ${error.message}`);
            }
        }

        async function populateAddTeamDropdowns() {
            // May not be needed if Add Team feature isn't implemented
        }

        async function populateTournamentParticipantsSelect() {
             const participantsContainer = document.getElementById('tournament-participants-list');
             const gameTypeSelect = document.getElementById('tournament-game-type-select');

             if (!participantsContainer || !gameTypeSelect) {
                 console.warn("Cannot populate tournament participants: elements missing.");
                 return;
             }

             const selectedGameType = gameTypeSelect.value;
             participantsContainer.innerHTML = '<p class="text-gray-500 p-2">Loading participants...</p>';

             if (selectedGameType === "1v1" || selectedGameType === "ffa") {
                 try {
                     if (!db) throw new Error("DB not connected");
                     const snapshot = await db.collection('players').orderBy('name').get();
                     if (snapshot.empty) {
                         participantsContainer.innerHTML = '<p class="text-gray-500 p-2">No players found.</p>';
                     } else {
                         participantsContainer.innerHTML = '';
                         snapshot.forEach(doc => {
                             const player = { id: doc.id, ...doc.data() };
                             const div = document.createElement('div');
                             div.className = 'flex items-center';
                             div.innerHTML = `
                                 <input type="checkbox" id="participant-${player.id}" name="participants" value="${player.id}" class="form-checkbox h-4 w-4 text-indigo-600">
                                 <label for="participant-${player.id}" class="ml-2 text-sm text-gray-700">${player.name || 'Unnamed'}</label>
                             `;
                             participantsContainer.appendChild(div);
                         });
                     }
                 } catch (error) {
                     console.error("Error fetching players for tournament:", error);
                     participantsContainer.innerHTML = '<p class="text-red-500 p-2">Error loading players.</p>';
                 }

             } else if (selectedGameType === "2v2" || selectedGameType === "team") {
                  participantsContainer.innerHTML = '<p class="text-gray-500 p-2 italic">Team selection not yet implemented.</p>';
             } else {
                  participantsContainer.innerHTML = '<p class="text-gray-500 p-2">Select a game type (1v1, 2v2, etc.)</p>';
             }
         }

        // --- Results Table Population (Firestore) ---
        async function populateResultsTable() {
            if (!resultsTableBody) { console.error("[RESULTS] Table body 'results-table-body' not found."); return; }
            if (!db) { console.error("[RESULTS] Firestore database (db) is not initialized."); resultsTableBody.innerHTML = '<tr><td colspan="4" class="text-red-500 text-center py-4">Database connection error.</td></tr>'; return; }

            console.log("[RESULTS] Populating results table...");
            resultsTableBody.innerHTML = '<tr><td colspan="4" class="text-gray-500 text-center py-4">Loading results...</td></tr>';

            try {
                const gamesCollection = db.collection('games');
                const snapshot = await gamesCollection.orderBy('date_played', 'asc').get();

                if (snapshot.empty) {
                    resultsTableBody.innerHTML = '<tr><td colspan="4" class="text-gray-500 text-center py-4">No game results found.</td></tr>';
                    return;
                }

                resultsTableBody.innerHTML = '';

                const playerCache = {};
                const getPlayerName = async (playerId) => {
                   if (!playerId) return 'N/A';
                   if (playerCache[playerId]) return playerCache[playerId];
                   try {
                       const playerDoc = await db.collection('players').doc(playerId).get();
                       const name = playerDoc.exists ? (playerDoc.data().name || 'Unnamed') : 'Unknown Player';
                       playerCache[playerId] = name;
                       return name;
                   } catch (err) { console.warn(`[RESULTS] Error fetching player ${playerId}:`, err); return 'Error'; }
                };

                for (const doc of snapshot.docs) {
                    const game = { id: doc.id, ...doc.data() };
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.setAttribute('data-game-id', game.id);

                    let gameDateStr = 'N/A';
                    if (game.date_played && typeof game.date_played.toDate === 'function') {
                        try { gameDateStr = game.date_played.toDate().toLocaleDateString(); }
                        catch (e) { console.warn("Error formatting date:", e, game.date_played); }
                    }

                    // Use gameTypesConfig for display name
                    const gameTypeDisplay = gameTypesConfig[game.game_type] || game.game_type || 'N/A';

                    let description = gameTypeDisplay;
                    const participants = game.participants || [];

                    if (participants.length > 0) {
                        const participantNames = await Promise.all(participants.map(id => getPlayerName(id)));

                        if (game.outcome === 'Win/Loss' && participants.length >= 2) {
                             description = `${gameTypeDisplay}: <b>${participantNames[0]}</b> defeated ${participantNames[1]}`;
                        } else if (game.outcome === 'Draw' && participants.length >= 2) {
                             description = `${gameTypeDisplay}: ${participantNames[0]} drew with ${participantNames[1]}`;
                        } else if (game.outcome === 'Ranked' && participants.length > 0) {
                             description = `${gameTypeDisplay}: ${participantNames.map((name, index) => `${index + 1}. ${name}`).join(', ')}`;
                        } else {
                            description = `${gameTypeDisplay}: ${participantNames.join(' vs ')}`;
                        }
                        if (game.score) description += ` <span class="text-gray-600">(${game.score})</span>`;
                    }

                    const actionsCellContent = `
                        <div class="admin-only">
                            <button class="text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded edit-game-btn">Edit</button>
                            <button class="text-xs bg-red-100 text-red-700 hover:bg-red-200 px-2 py-1 rounded delete-game-btn">Delete</button>
                        </div>`;

                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm">${gameDateStr}</td>
                        <td class="px-4 py-3 text-sm">${gameTypeDisplay}</td>
                        <td class="px-4 py-3 text-sm">${description}</td>
                        <td class="px-4 py-3 text-sm">${actionsCellContent}</td>
                    `;
                    resultsTableBody.appendChild(tr);
                }
                console.log(`[RESULTS] Populated results table with ${snapshot.size} games.`);

            } catch (error) {
                console.error("Error fetching games for results table:", error);
                resultsTableBody.innerHTML = `<tr><td colspan="4" class="text-red-500 text-center py-4">Error loading results: ${error.message}</td></tr>`;
            }
        }


        // --- Manage Tournaments List Population ---
        async function populateManageTournamentsList() {
            // This function might be repurposed or removed if full management isn't needed
            // For now, it's not called by the main UI flow
        }


        // --- Action Handlers for Edit/Delete Buttons ---
        function handleEditGame(gameId) {
             console.log(`Edit game clicked: ${gameId}`);
             alert(`Edit functionality for game ${gameId} not implemented yet.`);
        }

        async function handleDeleteGame(gameId, tableRowElement) {
             console.log(`Delete game clicked: ${gameId}`);
             if (!db) { console.error("Firestore not initialized."); return; }
             if (confirm(`Are you sure you want to delete game result ${gameId}?\nThis may affect rankings and cannot be undone.`)) {
                 try {
                     // TODO: Before deleting the game, consider reversing the Elo change.
                     await db.collection('games').doc(gameId).delete();
                     console.log(`[FIRESTORE] Firestore document deleted: games/${gameId}`);
                     if (tableRowElement) tableRowElement.remove();
                     alert(`Game ${gameId} deleted.`);
                     await populateDashboard(); // Refresh dashboard
                     // Refresh rankings if the current view might be affected
                     if (document.getElementById('rankings-section') && !document.getElementById('rankings-section').classList.contains('hidden')) {
                         await updateRankingsVisibility();
                     }
                 } catch (error) {
                     console.error("Error deleting game:", error);
                     alert(`Failed to delete game ${gameId}. See console for details.`);
                 }
             }
        }
        function handleEditTournament(tournamentId) {
            console.log(`Edit tournament clicked: ${tournamentId}`);
            alert(`Edit functionality for tournament ${tournamentId} not implemented yet.`);
        }
        async function handleDeleteTournament(tournamentId, listItemElement) {
            console.log(`Delete tournament clicked: ${tournamentId}`);
            if (!db) { console.error("Firestore not initialized."); return; }
            if (confirm(`Are you sure you want to delete tournament '${tournamentId}'? This cannot be undone.`)) {
                 try {
                     await db.collection('tournaments').doc(tournamentId).delete();
                     console.log(`[FIRESTORE] Firestore document deleted: tournaments/${tournamentId}`);
                     if (listItemElement) listItemElement.remove(); // Remove from UI if in manage view
                     alert(`Tournament deleted.`);
                     // Refresh public tournament lists
                     await populateTournamentsList('dashboard-tournaments-list', 3);
                     await populateTournamentsList('tournaments-list-full');
                 } catch (error) {
                     console.error("Error deleting tournament:", error);
                     alert(`Failed to delete tournament ${tournamentId}. See console for details.`);
                 }
             }
        }


        // --- Player Modal Edit Mode Handlers (Firestore) ---
        function togglePlayerModalEdit(editMode) {
            if (!playerInfoModal) return;
            if (editMode) {
                 playerInfoModal.classList.add('modal-editing');
                 playerInfoModal.querySelector('#modal-edit-player-name-input')?.focus();
            } else {
                 playerInfoModal.classList.remove('modal-editing');
            }
        }
        async function savePlayerChanges() {
            if (!playerInfoModal || !db) return;
            const playerId = playerInfoModal.getAttribute('data-current-player-id');
            if (!playerId) { alert("Error: No player ID found."); return; }

            const nameInput = playerInfoModal.querySelector('#modal-edit-player-name-input');
            const iconInput = playerInfoModal.querySelector('#modal-edit-player-icon-input');
            const newName = nameInput?.value.trim();
            const newIconUrl = iconInput?.value.trim() || null;

            if (!newName) { alert("Player name cannot be empty."); nameInput?.focus(); return; }

            // Only update name and iconUrl here. Elo and stats are updated via game results.
            const updatedData = { name: newName, iconUrl: newIconUrl };

            try {
                 await db.collection('players').doc(playerId).update(updatedData);
                 alert("Player details updated successfully!");
                 togglePlayerModalEdit(false);
                 playerInfoModal.querySelector('#modal-player-name').textContent = newName;
                 const iconSrc = newIconUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(newName || '?')}&background=E0E7FF&color=4F46E5&size=80`;
                 playerInfoModal.querySelector('#modal-player-icon').src = iconSrc;
                 if (playersGrid) await populatePlayersList(); // Refresh player grid
            } catch (error) {
                console.error(`Error updating player ${playerId}:`, error);
                alert(`Failed to update player: ${error.message}`);
            }
        }
        async function deletePlayer() {
             if (!playerInfoModal || !db) return;
             const playerId = playerInfoModal.getAttribute('data-current-player-id');
             const playerName = playerInfoModal.querySelector('#modal-player-name')?.textContent || 'this player';
             if (!playerId) { alert("Error: No player ID found."); return; }

             // IMPORTANT: Need to handle deleting games/tournament participation associated with the player in a real app
             if (confirm(`Are you sure you want to delete ${playerName} (${playerId})?\nThis cannot be undone and will remove them from all records.`)) {
                 try {
                     await db.collection('players').doc(playerId).delete();
                     alert(`${playerName} deleted successfully!`);
                     closePlayerModal();
                     // Refresh relevant lists
                     if (playersGrid) await populatePlayersList();
                     await populateDashboard();
                     await populateResultsTable();
                     await updateRankingsVisibility(); // Refresh rankings

                 } catch (error) {
                     console.error(`Error deleting player ${playerId}:`, error);
                     alert(`Failed to delete player: ${error.message}`);
                 }
             }
        }

        // --- Dashboard Population ---
        async function populateDashboard() {
            console.log("[DASHBOARD] Populating...");
            if (!db) { console.warn("[DASHBOARD] DB not ready, skipping population."); return; }
            await Promise.all([
                populateRecentGamesList('recent-games-list', 5),
                populateTopPlayersList('top-players-list', 5), // Shows overall Elo
                populateTopTeamsList('top-teams-list', 5), // Placeholder
                populateTournamentsList('dashboard-tournaments-list', 3)
            ]);
            console.log("[DASHBOARD] Population complete.");
        }

        // --- Dashboard / Recent Games Population ---
        async function populateRecentGamesList(elementId = 'recent-games-list', limit = 5) {
            const listElement = document.getElementById(elementId);
            if (!listElement || !db) { console.warn(`Recent games list #${elementId} or DB not ready.`); return; }
            listElement.innerHTML = `<li class="text-gray-500">Loading recent games...</li>`;
            try {
                // Requires index: games: date_played (desc)
                const q = db.collection('games').orderBy('date_played', 'desc').limit(limit);
                const snapshot = await q.get();
                if (snapshot.empty) {
                    listElement.innerHTML = `<li class="text-gray-500">No games recorded yet.</li>`;
                    return;
                }
                listElement.innerHTML = '';

                 const nameCache = {};
                 const getName = async (id) => {
                     if (!id) return 'N/A';
                     if (nameCache[id]) return nameCache[id];
                     try {
                         const doc = await db.collection('players').doc(id).get();
                         const name = doc.exists ? (doc.data().name || 'Unnamed') : 'Unknown';
                         nameCache[id] = name;
                         return name;
                     } catch (err) { return 'Error'; }
                 };

                for (const doc of snapshot.docs) {
                    const game = { id: doc.id, ...doc.data() };
                    const gameDate = game.date_played?.toDate ? game.date_played.toDate().toLocaleDateString() : 'N/A';
                    const gameType = gameTypesConfig[game.game_type] || game.game_type || 'Game'; // Use config for display name
                    let description = gameType;

                    const participants = game.participants || [];
                    if (participants.length >= 2 && (game.outcome === 'Win/Loss' || game.outcome === 'Draw')) {
                        const p1Name = await getName(participants[0]);
                        const p2Name = await getName(participants[1]);
                        if (game.outcome === 'Win/Loss') {
                             description = `${gameType}: <b>${p1Name}</b> beat ${p2Name}`;
                        } else {
                             description = `${gameType}: ${p1Name} drew with ${p2Name}`;
                        }
                    } else if (participants.length > 0) {
                        const names = await Promise.all(participants.map(id => getName(id)));
                        description = `${gameType}: ${names.join(', ')}`;
                    }
                    if (game.score) description += ` (${game.score})`;

                    const li = document.createElement('li');
                    li.className = 'border-b pb-2 mb-2 last:border-0 last:mb-0 last:pb-0 text-sm';
                    li.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>${description}</div>
                            <div class="text-gray-500 text-xs ml-2 whitespace-nowrap">${gameDate}</div>
                        </div>`;
                    listElement.appendChild(li);
                }
            } catch (error) {
                console.error(`Error fetching recent games for ${elementId}:`, error);
                 if (error.code === 'failed-precondition') {
                     listElement.innerHTML = `<li class="text-red-500">Error: Firestore index missing for date sorting. Check console.</li>`;
                     console.error("Firestore index needed: games collection, date_played (descending).");
                 } else {
                    listElement.innerHTML = `<li class="text-red-500">Error loading games: ${error.message}</li>`;
                 }
            }
        }

        // --- Dashboard / Top Players/Teams (Firestore based on Elo) ---
        async function populateTopPlayersList(elementId = 'top-players-list', limit = 5) {
             const listElement = document.getElementById(elementId);
             if (!listElement || !db) { console.warn(`Top players list #${elementId} or DB not ready.`); return; }
             listElement.innerHTML = '<li class="text-gray-500">Loading rankings...</li>';
             try {
                 // Requires index: players: elo_overall (desc)
                 const snapshot = await db.collection('players').orderBy('elo_overall', 'desc').limit(limit).get();
                 if (snapshot.empty) {
                     listElement.innerHTML = '<li class="text-gray-500">No players found.</li>'; return;
                 }
                 listElement.innerHTML = '';
                 let rank = 1;
                 snapshot.forEach(doc => {
                     const player = doc.data();
                     const li = document.createElement('li');
                     li.className = "flex justify-between items-center";
                     li.innerHTML = `
                         <span>${rank}. ${player.name || 'Unnamed'}</span>
                         <span class="text-sm font-medium text-indigo-600">${Math.round(player.elo_overall || DEFAULT_ELO)}</span>`;
                     listElement.appendChild(li);
                     rank++;
                 });
             } catch (error) {
                 console.error(`Error fetching top players:`, error);
                  if (error.code === 'failed-precondition') {
                     listElement.innerHTML = `<li class="text-red-500">Error: Firestore index missing for overall Elo sorting. Check console.</li>`;
                     console.error("Firestore index needed: players collection, elo_overall (descending).");
                 } else {
                    listElement.innerHTML = `<li class="text-red-500">Error loading rankings.</li>`;
                 }
             }
        }
        async function populateTopTeamsList(elementId = 'top-teams-list', limit = 5) {
             const listElement = document.getElementById(elementId);
             if (listElement) {
                 listElement.innerHTML = '<li class="text-gray-500 italic">Team rankings not yet implemented.</li>';
             }
        }

        // --- Tournaments List Population (Dashboard & Tournaments Page) ---
        async function populateTournamentsList(listElementId, limit = 10) {
             const listElement = document.getElementById(listElementId);
             if (!listElement || !db) { console.warn(`Tournament list #${listElementId} or DB not ready.`); return; }
             listElement.innerHTML = `<li class="text-gray-500">Loading tournaments...</li>`;
             try {
                 // Requires index: tournaments: date_created (desc)
                 const q = db.collection('tournaments').orderBy('date_created', 'desc').limit(limit);
                 const snapshot = await q.get();
                 if (snapshot.empty) {
                     listElement.innerHTML = `<li class="text-gray-500">No tournaments created yet.</li>`;
                     return;
                 }
                 listElement.innerHTML = '';
                 snapshot.forEach(doc => {
                     const tournament = { id: doc.id, ...doc.data() };
                     const li = document.createElement('li');
                     li.className = listElementId === 'dashboard-tournaments-list'
                         ? 'border-b pb-2 mb-2 last:border-0 last:pb-0'
                         : 'border p-4 rounded-lg hover:bg-gray-50 transition duration-200';

                     const status = tournament.status || 'Upcoming';
                     const statusColor = status === 'Ongoing' ? 'text-green-600' : (status === 'Completed' ? 'text-gray-500' : 'text-blue-600');
                     const gameType = gameTypesConfig[tournament.game_type] || tournament.game_type || 'N/A'; // Use config
                     const format = tournament.format || 'N/A';
                     const statusBg = status === 'Ongoing' ? 'bg-green-100' : (status === 'Completed' ? 'bg-gray-100' : 'bg-blue-100');

                     li.innerHTML = `
                         <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-lg">${tournament.name || 'Unnamed Tournament'}</span>
                            <span class="${statusColor} font-medium text-xs py-0.5 px-2 rounded-full bg-opacity-20 ${statusBg}">${status}</span>
                         </div>
                         <div class="text-sm text-gray-600 mb-2">
                             <span>Game: ${gameType}</span> | <span>Format: ${format}</span>
                         </div>
                         <a href="#tournament-detail-${tournament.id}" class="text-blue-600 hover:underline text-sm font-medium nav-link" data-target="tournament-detail-section">View Details</a>
                     `;
                     listElement.appendChild(li);
                 });
             } catch (error) {
                  console.error(`Error fetching tournaments for ${listElementId}:`, error);
                  if (error.code === 'failed-precondition') {
                     listElement.innerHTML = `<li class="text-red-500">Error: Firestore index missing for tournament date sorting. Check console.</li>`;
                     console.error("Firestore index needed: tournaments collection, date_created (descending).");
                 } else {
                    listElement.innerHTML = `<li class="text-red-500">Error loading tournaments: ${error.message}</li>`;
                 }
             }
        }

        // --- Rankings Page Population ---
        async function updateRankingsVisibility() {
            if (!rankingsGameFilter || !rankingTablesContainer || !db) {
                console.warn("Rankings filter, container, or DB not ready.");
                return;
            }
            const selectedGame = rankingsGameFilter.value;
            console.log(`[RANKING] Filter changed to: ${selectedGame}`);
            rankingTablesContainer.querySelectorAll('.ranking-table').forEach(table => table.classList.remove('active', 'hidden')); // Reset state
            rankingTablesContainer.querySelectorAll('.ranking-table').forEach(table => table.classList.add('hidden')); // Hide all

            const targetTable = document.getElementById(`ranking-table-${selectedGame}`);
            if (targetTable) {
                 targetTable.classList.remove('hidden'); // Show selected table container
                 targetTable.classList.add('active');

                 // Call the appropriate population function
                 if (selectedGame === 'overall') {
                     await populateOverallRankings();
                 // Add specific game handlers based on gameTypesConfig keys
                 } else if (gameTypesConfig[selectedGame]) {
                     // Construct function name dynamically (e.g., populatePoolRankings)
                     const functionName = `populate${selectedGame.charAt(0).toUpperCase() + selectedGame.slice(1)}Rankings`;
                     if (typeof window[functionName] === 'function') {
                         await window[functionName](); // Call the function if it exists
                     } else {
                         console.warn(`Ranking function ${functionName} not implemented.`);
                         const tbody = targetTable.querySelector('tbody');
                         if (tbody) tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500 italic">Rankings for ${gameTypesConfig[selectedGame]} not yet implemented.</td></tr>`;
                     }
                 } else {
                     // Handle unknown game selection (shouldn't happen with dynamic dropdown)
                      console.warn(`Unknown game type selected: ${selectedGame}`);
                      const tbody = targetTable.querySelector('tbody');
                      if (tbody) tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500 italic">Unknown game type selected.</td></tr>`;
                 }
            } else {
                 console.warn(`Ranking table container for "${selectedGame}" (ID: ranking-table-${selectedGame}) not found.`);
                 // Fallback to overall if specific table doesn't exist
                 const overallTable = document.getElementById('ranking-table-overall');
                 if (overallTable) {
                      overallTable.classList.remove('hidden');
                      overallTable.classList.add('active');
                      await populateOverallRankings();
                 }
            }
        }
        // Populates Overall 1v1 and 2v2 tables
        async function populateOverallRankings() {
             const elo1v1Body = document.getElementById('overall-1v1-rankings-body');
             const elo2v2Body = document.getElementById('overall-2v2-rankings-body');

             // Populate 1v1 Overall Rankings
             if (elo1v1Body && db) {
                 elo1v1Body.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Loading rankings...</td></tr>';
                 try {
                     // Requires index: players: elo_overall (desc)
                     const snapshot = await db.collection('players').orderBy('elo_overall', 'desc').limit(20).get();
                     if (snapshot.empty) {
                        elo1v1Body.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No players found.</td></tr>';
                     } else {
                         elo1v1Body.innerHTML = '';
                         let rank = 1;
                         snapshot.forEach(doc => {
                             const player = doc.data();
                             const tr = document.createElement('tr');
                             tr.className = 'border-b';
                             tr.innerHTML = `
                                 <td class="px-4 py-2">${rank}</td>
                                 <td class="px-4 py-2">${player.name || 'Unnamed'}</td>
                                 <td class="px-4 py-2">${Math.round(player.elo_overall || DEFAULT_ELO)}</td>
                             `;
                             elo1v1Body.appendChild(tr);
                             rank++;
                         });
                     }
                 } catch (error) {
                      console.error("Error loading Overall 1v1 rankings:", error);
                      if (error.code === 'failed-precondition') {
                         elo1v1Body.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">Error: Firestore index missing (players: elo_overall desc).</td></tr>';
                         console.error("Firestore index needed: players collection, elo_overall (descending).");
                      } else {
                         elo1v1Body.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">Error loading rankings.</td></tr>';
                      }
                 }
             }

             // Populate 2v2 Overall Rankings (Placeholder)
             if (elo2v2Body) {
                 elo2v2Body.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500 italic">2v2 Team rankings not implemented.</td></tr>';
             }
        }
        // Populates Pool Rankings Table
        async function populatePoolRankings() { await populateGameRankings('pool'); }
        // Add other specific game ranking functions here, calling the generic one
        async function populatePuttpongRankings() { await populateGameRankings('puttpong'); }
        async function populateCornholeRankings() { await populateGameRankings('cornhole'); }
        async function populatePickleballRankings() { await populateGameRankings('pickleball'); }
        async function populateBasketball_horseRankings() { await populateGameRankings('basketball_horse'); }

        // Generic function to populate game-specific rankings
        async function populateGameRankings(gameKey) {
             const tableBodyId = `${gameKey}-rankings-body`;
             const tableBody = document.getElementById(tableBodyId);
             const gameName = gameTypesConfig[gameKey] || gameKey; // Get display name

             if (!tableBody || !db) {
                 console.warn(`Rankings body #${tableBodyId} or DB not ready for ${gameName}.`);
                 if(tableBody) tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Initialization error for ${gameName}.</td></tr>`;
                 return;
             }

             tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">Loading ${gameName} rankings...</td></tr>`;
             try {
                 // Requires index: players: elos.<gameKey> (desc)
                 const fieldPath = `elos.${gameKey}`;
                 const snapshot = await db.collection('players').orderBy(fieldPath, 'desc').limit(20).get();

                 if (snapshot.empty) {
                    tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">No players with ${gameName} ratings found.</td></tr>`;
                 } else {
                     tableBody.innerHTML = '';
                     let rank = 1;
                     let playersFoundWithRating = false;
                     snapshot.forEach(doc => {
                         const player = doc.data();
                         // Check if the player has an Elo rating for this specific game
                         if (player.elos && typeof player.elos[gameKey] === 'number') {
                             playersFoundWithRating = true;
                             const tr = document.createElement('tr');
                             tr.className = 'border-b';
                             tr.innerHTML = `
                                 <td class="px-4 py-2">${rank}</td>
                                 <td class="px-4 py-2">${player.name || 'Unnamed'}</td>
                                 <td class="px-4 py-2">${Math.round(player.elos[gameKey])}</td>
                             `;
                             tableBody.appendChild(tr);
                             rank++;
                         }
                     });
                     // Handle case where players exist but none have a rating for this game
                     if (!playersFoundWithRating) {
                          tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">No players with ${gameName} ratings found.</td></tr>`;
                     }
                 }
             } catch (error) {
                  console.error(`Error loading ${gameName} rankings:`, error);
                  if (error.code === 'failed-precondition') {
                     tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Error: Firestore index missing (players: elos.${gameKey} desc). Check console.</td></tr>`;
                     console.error(`Firestore index needed: players collection, elos.${gameKey} (descending).`);
                  } else {
                     tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Error loading ${gameName} rankings.</td></tr>`;
                  }
             }
        }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
             console.log("[LISTENERS] Setting up...");
            navLinks?.forEach(link => link.addEventListener('click', handleNavLinkClick));
            loginForm?.addEventListener('submit', handleLoginFormSubmit);
            logoutButton?.addEventListener('click', logout);

            // Contextual Admin Buttons
            openRecordGameModalBtn?.addEventListener('click', openRecordGameModal);
            openAddPlayerModalBtn?.addEventListener('click', openAddPlayerModal);
            openCreateTournamentModalBtn?.addEventListener('click', openCreateTournamentModal);
            openAddGameModalBtn?.addEventListener('click', openAddGameModal); // New listener

            // Modal Overlay Click-to-Close (for ALL modals)
            [recordGameModal, playerInfoModal, addPlayerModal, createTournamentModal, addGameModal].forEach(modal => { // Added addGameModal
                 modal?.addEventListener('click', (event) => {
                     if (event.target === modal) { // Only close if overlay itself is clicked
                         if (modal.id === 'record-game-modal') closeRecordGameModal();
                         if (modal.id === 'player-info-modal') closePlayerModal();
                         if (modal.id === 'add-player-modal') closeAddPlayerModal();
                         if (modal.id === 'create-tournament-modal') closeCreateTournamentModal();
                         if (modal.id === 'add-game-modal') closeAddGameModal(); // New
                     }
                 });
            });

            rankingsGameFilter?.addEventListener('change', updateRankingsVisibility);
            playerInfoModal?.querySelector('.modal-content')?.addEventListener('click', (event) => {
                if (event.target.matches('#close-player-modal-btn')) closePlayerModal();
                else if (event.target.matches('#edit-player-modal-btn')) togglePlayerModalEdit(true);
                else if (event.target.matches('#save-player-changes-btn')) savePlayerChanges();
                else if (event.target.matches('#cancel-player-edit-btn')) togglePlayerModalEdit(false);
                else if (event.target.matches('#delete-player-btn')) deletePlayer();
            });

            // Form submissions are now handled inside the modal open functions or specific handlers

            playersGrid?.addEventListener('click', (event) => {
                const playerEntry = event.target.closest('.player-entry');
                if (playerEntry) {
                    const playerId = playerEntry.getAttribute('data-player-id');
                    if (playerId) openPlayerModal(playerId);
                }
            });
            resultsTableBody?.addEventListener('click', (event) => {
                const targetButton = event.target;
                const gameRow = targetButton.closest('tr[data-game-id]');
                if (!gameRow) return;
                const gameId = gameRow.getAttribute('data-game-id');
                if (!gameId) return;
                if (targetButton.classList.contains('edit-game-btn')) handleEditGame(gameId);
                else if (targetButton.classList.contains('delete-game-btn')) handleDeleteGame(gameId, gameRow);
            });
             manageTournamentsListContainer?.addEventListener('click', (event) => {
                 const targetButton = event.target;
                 const tournamentItem = targetButton.closest('li[data-tournament-id]');
                 if (!tournamentItem) return;
                 const tournamentId = tournamentItem.getAttribute('data-tournament-id');
                 if (!tournamentId) return;
                 if (targetButton.classList.contains('edit-tournament-btn')) handleEditTournament(tournamentId);
                 else if (targetButton.classList.contains('delete-tournament-btn')) handleDeleteTournament(tournamentId, tournamentItem);
             });
             console.log("[LISTENERS] Setup complete.");
        }

        // --- Specific Event Handlers ---
        function handleNavLinkClick(event) {
            const targetId = event.currentTarget.getAttribute('data-target');
            if (targetId) {
                event.preventDefault();
                showSection(targetId);
            }
        }
        function handleLoginFormSubmit(event) {
            event.preventDefault();
            const passwordInput = document.getElementById('password');
            if (passwordInput) login(passwordInput.value);
        }

        // --- Admin Login/Logout Logic ---
        function checkLoginState() {
             const isLoggedIn = sessionStorage.getItem('isAdminLoggedIn') === 'true';
             if (isLoggedIn) {
                 document.body.classList.add('admin-logged-in');
             } else {
                 document.body.classList.remove('admin-logged-in');
             }
             return isLoggedIn;
        }
        function login(password) {
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                checkLoginState();
                showSection('home'); // Navigate to home after login
                loginError?.classList.add('hidden');
                const passwordInput = document.getElementById('password');
                if(passwordInput) passwordInput.value = '';
            } else {
                loginError?.classList.remove('hidden');
            }
        }
        function logout() {
            sessionStorage.removeItem('isAdminLoggedIn');
            checkLoginState(); // Update UI
            showSection('home'); // Navigate to home on logout
        }

        // --- Form Submission Handlers (Now triggered from modals) ---

        // Specific handler for the Add Player modal form
        async function handleAddPlayerSubmit(event) {
            event.preventDefault();
            const form = event.target;
            if (!db) { alert("Database connection error."); return; }

            let isValid = true;
            form.querySelectorAll('input[required]').forEach(field => {
                field.classList.remove('border-red-500');
                if (!field.value) { isValid = false; field.classList.add('border-red-500'); }
            });
            if (!isValid) { alert("Please fill out all required fields."); return; }

            const formData = new FormData(form);
            const playerName = formData.get('player-name')?.trim();
            const playerIconUrl = formData.get('player-icon-url')?.trim() || null;

            if (!playerName) return;

            try {
                 // Initialize elos map with default ratings for all known games + overall
                 const initialElos = { overall: DEFAULT_ELO };
                 // Use the current ELO_GAME_KEYS derived from gameTypesConfig
                 ELO_GAME_KEYS.forEach(gameKey => {
                     initialElos[gameKey] = DEFAULT_ELO;
                 });

                 const playerData = {
                     name: playerName,
                     elo_overall: DEFAULT_ELO, // Keep overall separate for now
                     elos: initialElos, // Nested map for game-specific Elos
                     // Initialize overall stats
                     wins: 0,
                     losses: 0,
                     draws: 0,
                     games_played: 0,
                     date_created: firebase.firestore.FieldValue.serverTimestamp()
                 };
                 if (playerIconUrl) {
                     playerData.iconUrl = playerIconUrl;
                 }

                 await db.collection('players').add(playerData);
                 alert(`Player "${playerName}" added successfully!`);
                 closeAddPlayerModal();
                 if (playersGrid) await populatePlayersList();

            } catch (error) {
                 console.error("Error adding player:", error);
                 alert(`Failed to add player: ${error.message}`);
            }
        }

        // Specific handler for the Create Tournament modal form
        async function handleCreateTournamentSubmit(event) {
            event.preventDefault();
            const form = event.target;
            if (!db) { alert("Database connection error."); return; }

            let isValid = true;
            form.querySelectorAll('input[required], select[required]').forEach(field => {
                field.classList.remove('border-red-500');
                if (!field.value) { isValid = false; field.classList.add('border-red-500'); }
            });
            if (!isValid) { alert("Please fill out all required fields."); return; }

            const formData = new FormData(form);
            const selectedParticipants = [];
            form.querySelectorAll('input[name="participants"]:checked').forEach(checkbox => {
                selectedParticipants.push(checkbox.value);
            });

            const format = formData.get('tournament-format');
            if (format !== 'ffa' && selectedParticipants.length < 2) {
                 alert("Please select at least two participants for this format.");
                 return;
            }

             const tournamentData = {
                 name: formData.get('tournament-name')?.trim(),
                 game_type: formData.get('tournament-game-type'),
                 format: format,
                 start_date: formData.get('tournament-start-date') || null,
                 participants: selectedParticipants,
                 status: 'Upcoming',
                 date_created: firebase.firestore.FieldValue.serverTimestamp(),
             };

             if (!tournamentData.name || !tournamentData.game_type || !tournamentData.format) return;

             try {
                 await db.collection('tournaments').add(tournamentData);
                 alert(`Tournament "${tournamentData.name}" created successfully!`);
                 closeCreateTournamentModal();
                 await populateTournamentsList('dashboard-tournaments-list', 3);
                 await populateTournamentsList('tournaments-list-full');
             } catch (error) {
                 console.error("Error creating tournament:", error);
                 alert(`Failed to create tournament: ${error.message}`);
             }
        }


        // Specific handler for the Record Game modal form submission
        async function handleRecordGameSubmit(event) {
             event.preventDefault();
             const form = event.target;
             if (!db) { alert("Database connection error."); return; }

             let isValid = true;
             form.querySelectorAll('select[required]').forEach(field => {
                 field.classList.remove('border-red-500');
                 if (!field.value) { isValid = false; field.classList.add('border-red-500'); }
             });
             const winnerSelect = form.querySelector('#winner_player');
             const loserSelect = form.querySelector('#loser_player');
             const winnerId = winnerSelect.value;
             const loserId = loserSelect.value;
             const isDraw = form.querySelector('#is_draw').checked;
             const gameType = form.querySelector('#game-type-select-modal').value;

             if (!gameType) {
                 alert("Please select a game type.");
                 form.querySelector('#game-type-select-modal').classList.add('border-red-500');
                 isValid = false;
             }
             if (!isDraw && winnerId === loserId) {
                 alert("Winner and Loser cannot be the same player unless it's a draw.");
                 winnerSelect.classList.add('border-red-500'); loserSelect.classList.add('border-red-500'); isValid = false;
             } else if (isDraw && (!winnerId || !loserId)) {
                 alert("Please select both players for a draw.");
                 if (!winnerId) winnerSelect.classList.add('border-red-500');
                 if (!loserId) loserSelect.classList.add('border-red-500'); isValid = false;
             }
             if (!isValid) { alert("Please correct the errors in the form."); return; }

             const gameData = {
                 game_type: gameType,
                 date_played: firebase.firestore.FieldValue.serverTimestamp(),
                 score: form.querySelector('#score').value.trim() || null,
                 outcome: isDraw ? 'Draw' : 'Win/Loss',
                 participants: isDraw ? [winnerId, loserId].sort() : [winnerId, loserId],
             };

             console.log("[GAME RECORD] Recording game data:", gameData);

             try {
                 // --- ELO Calculation & Stat Updates ---
                 let eloUpdates = {};
                 const FieldValue = firebase.firestore.FieldValue; // For increment
                 const winnerStatUpdates = { games_played: FieldValue.increment(1) };
                 const loserStatUpdates = { games_played: FieldValue.increment(1) };

                 // Only calculate Elo if the game type is in our list
                 if (ELO_GAME_KEYS.includes(gameType)) {
                     if (!isDraw) {
                        eloUpdates = await calculateEloUpdate(winnerId, loserId, gameType);
                        winnerStatUpdates.wins = FieldValue.increment(1);
                        loserStatUpdates.losses = FieldValue.increment(1);
                     } else {
                        eloUpdates = await calculateEloUpdateDraw(winnerId, loserId, gameType);
                        winnerStatUpdates.draws = FieldValue.increment(1);
                        loserStatUpdates.draws = FieldValue.increment(1);
                     }
                     console.log("[ELO] Calculated Elo Updates:", eloUpdates);
                 } else {
                     console.log(`[ELO] Skipping Elo calculation for non-Elo game type: ${gameType}`);
                     // Still update basic stats for non-Elo games if desired
                     if (!isDraw) {
                         winnerStatUpdates.wins = FieldValue.increment(1);
                         loserStatUpdates.losses = FieldValue.increment(1);
                     } else {
                         winnerStatUpdates.draws = FieldValue.increment(1);
                         loserStatUpdates.draws = FieldValue.increment(1);
                     }
                 }

                 // Combine Elo and Stat updates
                 const finalUpdates = {};
                 if (eloUpdates[winnerId] || Object.keys(winnerStatUpdates).length > 0) {
                     finalUpdates[winnerId] = { ...(eloUpdates[winnerId] || {}), ...winnerStatUpdates };
                 }
                 if (eloUpdates[loserId] || Object.keys(loserStatUpdates).length > 0) {
                      finalUpdates[loserId] = { ...(eloUpdates[loserId] || {}), ...loserStatUpdates };
                 }
                 console.log("[STATS & ELO] Combined Updates:", finalUpdates);
                 // --- End ELO & Stat Updates ---

                 // Save game document to Firestore
                 const docRef = await db.collection('games').add(gameData);
                 console.log("[FIRESTORE] Recorded new game with ID:", docRef.id);

                 // --- Update Player Elo & Stats using Batch Write ---
                 if (Object.keys(finalUpdates).length > 0) {
                    await updatePlayerElos(finalUpdates);
                 } else {
                    console.warn("[ELO/STATS] No Elo or Stat updates to apply.");
                 }
                 // --- End Elo & Stat Update ---

                 alert("Game result recorded successfully!");
                 closeRecordGameModal();
                 if (db) {
                    await populateResultsTable();
                    await populateDashboard();
                    if (document.getElementById('rankings-section') && !document.getElementById('rankings-section').classList.contains('hidden')) {
                         await updateRankingsVisibility();
                    }
                 }
             } catch (error) {
                 console.error("Error saving game result or updating Elo/Stats:", error);
                 alert(`Error saving game result: ${error.message}`);
             }
        }

        // --- Add New Game Handler (NEW) ---
        async function handleAddGameSubmit(event) {
            event.preventDefault();
            const form = event.target;
            if (!db) { alert("Database connection error."); return; }

            const formData = new FormData(form);
            const gameKey = formData.get('new-game-key')?.trim().toLowerCase();
            const gameName = formData.get('new-game-name')?.trim();

            // Validation
            if (!gameKey || !gameName) {
                alert("Please enter both a Game Key and a Display Name.");
                return;
            }
            // Basic validation for key format (lowercase, numbers, underscores)
            if (!/^[a-z0-9_]+$/.test(gameKey)) {
                alert("Game Key can only contain lowercase letters, numbers, and underscores.");
                form.querySelector('#new-game-key').classList.add('border-red-500');
                return;
            }
            if (gameTypesConfig[gameKey]) {
                alert(`Game Key "${gameKey}" already exists.`);
                form.querySelector('#new-game-key').classList.add('border-red-500');
                return;
            }

            console.log(`[ADD GAME] Attempting to add: Key=${gameKey}, Name=${gameName}`);

            // 1. Update local config (this won't persist across page loads unless saved)
            gameTypesConfig[gameKey] = gameName;
            ELO_GAME_KEYS = Object.keys(gameTypesConfig); // Update the keys list
            console.log("[ADD GAME] Updated local gameTypesConfig:", gameTypesConfig);

            // 2. Update UI Elements (Dropdowns, potentially add ranking table dynamically)
            updateGameTypeDropdowns();
            // TODO: Dynamically add a new ranking table structure to the HTML if it doesn't exist
            // For simplicity now, assume tables for common games are pre-defined in HTML

            // 3. Update existing players (potentially slow/costly!)
            alert("Updating existing players with new game rating... This might take a moment.");
            try {
                const playersRef = db.collection('players');
                const snapshot = await playersRef.get();
                const batch = db.batch();
                let operationCount = 0;

                if (snapshot.empty) {
                    console.log("[ADD GAME] No existing players found to update.");
                } else {
                    console.log(`[ADD GAME] Found ${snapshot.size} players to update.`);
                    snapshot.forEach(doc => {
                        const playerRef = playersRef.doc(doc.id);
                        const updateData = {};
                        updateData[`elos.${gameKey}`] = DEFAULT_ELO; // Add new game with default Elo
                        batch.update(playerRef, updateData);
                        operationCount++;

                        // Firestore batch limit is 500 operations. Commit and start new batch if needed.
                        // Note: This simple batching might still timeout on very large datasets.
                        if (operationCount >= 499) { // Leave a little buffer
                             console.warn("[ADD GAME] Batch limit reached, committing partial batch...");
                             batch.commit().then(() => console.log("[ADD GAME] Partial batch committed.")); // Commit current batch
                             batch = db.batch(); // Start a new batch
                             operationCount = 0;
                        }
                    });

                    // Commit any remaining operations in the last batch
                    if (operationCount > 0) {
                         await batch.commit();
                         console.log("[ADD GAME] Final player update batch committed.");
                    }
                }

                alert(`Game "${gameName}" added successfully! Existing players updated.`);
                closeAddGameModal();
                // Refresh rankings view if currently visible
                if (rankingsGameFilter) updateRankingsVisibility();

            } catch (error) {
                console.error("Error updating existing players with new game:", error);
                alert(`Failed to update existing players: ${error.message}. The game type was added locally but may not be reflected for existing players.`);
                // Optionally revert local config change: delete gameTypesConfig[gameKey]; updateGameTypeDropdowns();
            }
        }


        // --- Elo Calculation & Update Functions ---
        async function calculateEloUpdate(winnerId, loserId, gameType) {
            if (!db || !winnerId || !loserId || !gameType) { console.error("[ELO Calc] Missing required parameters or DB connection."); return {}; }
            console.log(`[ELO Calc] Calculating update for ${gameType}: Winner=${winnerId}, Loser=${loserId}`);
            try {
                const winnerRef = db.collection('players').doc(winnerId);
                const loserRef = db.collection('players').doc(loserId);
                const [winnerDoc, loserDoc] = await Promise.all([winnerRef.get(), loserRef.get()]);
                if (!winnerDoc.exists || !loserDoc.exists) { console.error("[ELO Calc] Winner or loser document not found."); alert("Error: Could not find player data for Elo calculation."); return {}; }
                const winnerData = winnerDoc.data(); const loserData = loserDoc.data();
                const winnerElo = winnerData.elos?.[gameType] || DEFAULT_ELO;
                const loserElo = loserData.elos?.[gameType] || DEFAULT_ELO;
                console.log(`[ELO Calc] Current ${gameType} Elo: Winner=${winnerElo}, Loser=${loserElo}`);
                const exponent = (loserElo - winnerElo) / 400;
                const expectedScoreWinner = 1 / (1 + Math.pow(10, exponent));
                const expectedScoreLoser = 1 - expectedScoreWinner;
                const newWinnerElo = Math.round(winnerElo + K_FACTOR * (1 - expectedScoreWinner));
                const newLoserElo = Math.round(loserElo + K_FACTOR * (0 - expectedScoreLoser));
                console.log(`[ELO Calc] New ${gameType} Elo: Winner=${newWinnerElo}, Loser=${newLoserElo}`);
                const winnerUpdates = {}; winnerUpdates[`elos.${gameType}`] = newWinnerElo;
                const loserUpdates = {}; loserUpdates[`elos.${gameType}`] = newLoserElo;
                return { [winnerId]: winnerUpdates, [loserId]: loserUpdates };
            } catch (error) { console.error("[ELO Calc] Error calculating Elo update:", error); alert(`Error calculating Elo: ${error.message}`); return {}; }
        }
        async function calculateEloUpdateDraw(player1Id, player2Id, gameType) {
             if (!db || !player1Id || !player2Id || !gameType) { console.error("[ELO Calc Draw] Missing required parameters or DB connection."); return {}; }
             console.log(`[ELO Calc Draw] Calculating update for ${gameType} Draw: P1=${player1Id}, P2=${player2Id}`);
             try {
                const p1Ref = db.collection('players').doc(player1Id); const p2Ref = db.collection('players').doc(player2Id);
                const [p1Doc, p2Doc] = await Promise.all([p1Ref.get(), p2Ref.get()]);
                if (!p1Doc.exists || !p2Doc.exists) { console.error("[ELO Calc Draw] Player document not found."); alert("Error: Could not find player data for Elo calculation."); return {}; }
                const p1Data = p1Doc.data(); const p2Data = p2Doc.data();
                const p1Elo = p1Data.elos?.[gameType] || DEFAULT_ELO; const p2Elo = p2Data.elos?.[gameType] || DEFAULT_ELO;
                console.log(`[ELO Calc Draw] Current ${gameType} Elo: P1=${p1Elo}, P2=${p2Elo}`);
                const exponent1 = (p2Elo - p1Elo) / 400; const expectedScoreP1 = 1 / (1 + Math.pow(10, exponent1)); const expectedScoreP2 = 1 - expectedScoreP1;
                const newP1Elo = Math.round(p1Elo + K_FACTOR * (0.5 - expectedScoreP1)); const newP2Elo = Math.round(p2Elo + K_FACTOR * (0.5 - expectedScoreP2));
                console.log(`[ELO Calc Draw] New ${gameType} Elo: P1=${newP1Elo}, P2=${newP2Elo}`);
                const p1Updates = {}; p1Updates[`elos.${gameType}`] = newP1Elo;
                const p2Updates = {}; p2Updates[`elos.${gameType}`] = newP2Elo;
                return { [player1Id]: p1Updates, [player2Id]: p2Updates };
             } catch (error) { console.error("[ELO Calc Draw] Error calculating Elo update:", error); alert(`Error calculating Elo for draw: ${error.message}`); return {}; }
        }
        async function updatePlayerElos(combinedUpdates) {
             if (!db || Object.keys(combinedUpdates).length === 0) { console.warn("[ELO/STATS Update] No updates to apply or DB not connected."); return; }
             console.log("[ELO/STATS Update] Starting batch update:", combinedUpdates);
             const batch = db.batch();
             Object.entries(combinedUpdates).forEach(([playerId, updates]) => {
                 if (playerId && typeof updates === 'object' && updates !== null) {
                     const playerRef = db.collection('players').doc(playerId);
                     batch.update(playerRef, updates);
                     console.log(`[ELO/STATS Update] Adding update for ${playerId}:`, updates);
                 } else {
                     console.warn(`[ELO/STATS Update] Skipping invalid update entry for player ID: ${playerId}`, updates);
                 }
             });
             try {
                 await batch.commit();
                 console.log("[FIRESTORE] Batch Elo/Stat update committed successfully.");
             } catch (error) {
                 console.error("[FIRESTORE] Batch Elo/Stat update failed:", error);
                 alert(`Failed to update player ratings/stats: ${error.message}`);
                 throw error;
             }
        }
        // --- End Elo Functions ---

        // --- Initialization Function ---
        function initializeApp() {
             try {
                console.log("[INIT] Initializing App...");
                assignElements();
                if (!db) { console.error("[INIT] Firebase DB connection failed. App functionality will be limited."); }

                updateGameTypeDropdowns(); // Initial population of dropdowns
                const isLoggedIn = checkLoginState();
                setupEventListeners();

                const initialHash = window.location.hash;
                let initialSectionId = 'home-section';
                if (initialHash && initialHash !== '#') {
                     const targetIdFromHash = initialHash.substring(1);
                     const targetSection = document.getElementById(targetIdFromHash);
                     if (targetSection?.classList.contains('page-section')) {
                          initialSectionId = targetIdFromHash;
                     }
                }
                // Initial section display and population is handled here
                showSection(initialSectionId);

                console.log("[INIT] App Initialized Successfully (DB connection attempted).");
             } catch (error) {
                 console.error("Error during app initialization:", error);
                 alert(`An error occurred while initializing the application: ${error.message}. Please check the console.`);
             }
        }

        // --- Run Initialization on DOM Load ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>
