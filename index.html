<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeaderBored - Friendly Competition Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Styles remain the same */
        body { font-family: 'Inter', sans-serif; }
        a, button, .player-entry { transition: all 0.2s ease-in-out; }
        .admin-only { display: none; }
        body.admin-logged-in .admin-only { display: block; }
        body.admin-logged-in .public-only { display: none; }
        .outcome-section, .sub-type-section { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .outcome-section.active, .sub-type-section.active { display: block; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 1.5rem 2rem 2rem 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-width: 95%; width: 550px; max-height: 90vh; overflow-y: auto; position: relative; transform: translateY(-20px) scale(0.98); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0; }
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); opacity: 1; }
        .modal-close-button { position: absolute; top: 0.5rem; right: 0.75rem; background: none; border: none; font-size: 1.75rem; font-weight: bold; color: #6b7280; cursor: pointer; padding: 0.25rem; line-height: 1; }
        .modal-close-button:hover { color: #1f2937; }
        .ranking-table { display: none; }
        .ranking-table.active { display: block; }
        .multi-select-list { max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; background-color: #f9fafb; }
        td, th { white-space: nowrap; padding-left: 1rem; padding-right: 1rem; padding-top: 0.75rem; padding-bottom: 0.75rem; }
        td { white-space: normal; }
        .border-red-500 { border-color: #ef4444; }
        .modal-editing .editable-field { display: none; }
        .modal-editing .editing-field { display: block; }
        .editing-field { display: none; }
        .modal-editing .edit-mode-controls { display: inline-flex; }
        .edit-mode-controls { display: none; }
        .modal-editing .view-mode-controls { display: none; }
        .admin-content-panel { display: none; margin-top: 2rem; }
        .admin-content-panel.active { display: block; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-cyan-50 text-gray-800">
    <nav class="bg-gradient-to-r from-cyan-600 to-blue-700 text-white p-5 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#home" class="text-3xl font-bold hover:text-blue-100 nav-link" data-target="home-section">üèÜ LeaderBored</a>
            <div class="space-x-5">
                <a href="#home" class="hover:text-blue-100 px-3 py-2 rounded-md text-base font-medium nav-link" data-target="home-section">Home</a>
                <a href="#rankings" class="hover:text-blue-100 px-3 py-2 rounded-md text-base font-medium nav-link" data-target="rankings-section">Rankings</a>
                <a href="#players" class="hover:text-blue-100 px-3 py-2 rounded-md text-base font-medium nav-link" data-target="players-section">Players</a>
                <a href="#tournaments" class="hover:text-blue-100 px-3 py-2 rounded-md text-base font-medium nav-link" data-target="tournaments-section">Tournaments</a>
                <a href="#login" id="login-link" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium public-only nav-link shadow hover:shadow-md" data-target="login-section">Admin Login</a>
                <a href="#admin" id="admin-link" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium admin-only nav-link shadow hover:shadow-md" data-target="admin-section">Admin Panel</a>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium admin-only shadow hover:shadow-md">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-8 p-6">
        <section id="home-section" class="page-section space-y-8"> <h1 class="text-4xl font-bold text-gray-900 border-b-2 border-blue-200 pb-3 mb-6">Dashboard</h1> <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"> <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300"> <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Recent Games</h2> <ul id="recent-games-list" class="space-y-4 text-base"> <li class="text-gray-500">Loading recent games...</li> </ul> <a href="#games" class="text-blue-600 hover:underline mt-5 inline-block font-medium">View all games...</a> </div> <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300"> <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Top Players (Overall)</h2> <ol id="top-players-list" class="list-decimal list-inside space-y-3 text-base"> <li class="text-gray-500">Loading rankings...</li></ol> <a href="#rankings" class="text-blue-600 hover:underline mt-5 inline-block font-medium nav-link" data-target="rankings-section">View full rankings...</a> </div> <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300"> <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Top Teams (Overall)</h2> <ol id="top-teams-list" class="list-decimal list-inside space-y-3 text-base"> <li class="text-gray-500">Loading rankings...</li></ol> <a href="#rankings" class="text-blue-600 hover:underline mt-5 inline-block font-medium nav-link" data-target="rankings-section">View full rankings...</a> </div> <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 md:col-span-2 lg:col-span-1"> <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Tournaments</h2> <ul id="dashboard-tournaments-list" class="space-y-4"> <li class="text-gray-500">Loading tournaments...</li></ul> <a href="#tournaments" class="text-blue-600 hover:underline mt-5 inline-block font-medium nav-link" data-target="tournaments-section">View all tournaments...</a> </div> </div> </section>
        <section id="rankings-section" class="page-section hidden space-y-8"> <div class="flex justify-between items-center border-b-2 border-blue-200 pb-3 mb-6"> <h1 class="text-4xl font-bold text-gray-900">Rankings</h1> <div> <label for="rankings-game-filter" class="text-sm font-medium text-gray-700 mr-2">Filter by Game:</label> <select id="rankings-game-filter" name="rankings-game-filter" class="shadow-sm border border-gray-300 rounded-lg py-2 px-3 text-base focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"> <option value="overall">Overall (1v1/2v2)</option> <option value="pool">Pool</option> <option value="puttpong">PuttPong</option> <option value="golf">Golf</option> <option value="basketball_pickup">Basketball (Pickup)</option> <option value="basketball_horse">Basketball (HORSE)</option> <option value="volleyball_pickup">Volleyball (Pickup)</option> <option value="board_card">Board / Card Game</option> <option value="cornhole">Cornhole</option> <option value="pickleball">Pickleball</option> </select> </div> </div> <div id="ranking-tables-container"> <div id="ranking-table-overall" class="ranking-table active grid grid-cols-1 md:grid-cols-2 gap-8"> <div class="bg-white p-8 rounded-xl shadow-lg"> <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Overall 1v1 Rankings (Elo)</h2> <table class="w-full text-left table-auto text-base"> <thead> <tr class="bg-gray-100"> <th class="px-4 py-3">Rank</th> <th class="px-4 py-3">Player</th> <th class="px-4 py-3">Rating</th> </tr> </thead> <tbody id="overall-1v1-rankings-body"> <tr class="border-b"><td colspan="3" class="text-center text-gray-500 py-4">Loading...</td></tr> </tbody> </table> </div> <div class="bg-white p-8 rounded-xl shadow-lg"> <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Overall 2v2 Team Rankings (Elo)</h2> <table class="w-full text-left table-auto text-base"> <thead> <tr class="bg-gray-100"> <th class="px-4 py-3">Rank</th> <th class="px-4 py-3">Team</th> <th class="px-4 py-3">Rating</th> </tr> </thead> <tbody id="overall-2v2-rankings-body"> <tr class="border-b"><td colspan="3" class="text-center text-gray-500 py-4">Loading...</td></tr> </tbody> </table> </div> </div> </div> </section>
        <section id="players-section" class="page-section hidden space-y-8"> <h1 class="text-4xl font-bold text-gray-900 border-b-2 border-blue-200 pb-3 mb-6">Players</h1> <div id="players-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"> <p class="text-gray-500 col-span-full text-center">Loading players...</p> </div> </section>
        <section id="tournaments-section" class="page-section hidden space-y-8"> <h1 class="text-4xl font-bold text-gray-900 border-b-2 border-blue-200 pb-3 mb-6">Tournaments</h1> <div class="bg-white p-8 rounded-xl shadow-lg"> <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Tournament List</h2> <div id="tournaments-list-full" class="space-y-6"> <p class="text-gray-500">Loading tournaments...</p> </div> </div> <div class="admin-only mt-6"> <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 admin-nav-button" data-target="admin-content-create-tournament"> Create New Tournament </button> </div> </section>
        <section id="tournament-detail-section" class="page-section hidden space-y-8"> <h1 class="text-4xl font-bold text-gray-900 border-b-2 border-blue-200 pb-3 mb-6">Tournament: <span id="tournament-detail-name">[Tournament Name]</span></h1> <div class="bg-white p-8 rounded-xl shadow-lg"> <p class="text-lg mb-1"><strong>Game:</strong> <span id="tournament-detail-game">[Game]</span></p> <p class="text-lg mb-1"><strong>Format:</strong> <span id="tournament-detail-format">[Format]</span></p> <p class="text-lg mb-4"><strong>Status:</strong> <span id="tournament-detail-status">[Status]</span></p> <h2 class="text-2xl font-semibold mt-8 mb-5 text-indigo-700">Bracket / Matches / Standings</h2> <div id="tournament-detail-visualization" class="border-2 border-dashed border-gray-300 p-12 text-center text-gray-500 rounded-lg min-h-[250px]"> Tournament Visualization Area <br>(Requires JavaScript library or custom rendering based on format) </div> <div class="admin-only mt-6"> <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50"> Report Match Result </button> </div> </div> </section>
        <section id="login-section" class="page-section hidden"> <h1 class="text-4xl font-bold text-gray-900 border-b-2 border-blue-200 pb-3 mb-6 text-center">Admin Login</h1> <div class="bg-white p-10 rounded-xl shadow-xl max-w-lg mx-auto"> <form id="login-form"> <div class="mb-6"> <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label> <input type="password" id="password" name="password" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> </div> <div id="login-error" class="text-red-500 text-sm mb-4 hidden">Incorrect password.</div> <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"> Login </button> </form> </div> </section>

        <section id="admin-section" class="page-section hidden admin-only space-y-8">
            <h1 class="text-4xl font-bold text-gray-900 border-b-2 border-blue-200 pb-3 mb-6">Admin Panel</h1>
            <p class="text-green-700 bg-green-100 border border-green-300 p-4 rounded-lg text-center font-medium">You are logged in as Admin.</p>

            <div id="admin-button-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300">
                    <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Add / Record</h2>
                    <div class="space-y-4">
                        <button class="w-full text-left bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 px-5 rounded-lg shadow-sm hover:shadow-md admin-nav-button" data-target="admin-content-add-player">‚ûï Add New Player</button>
                        <button class="w-full text-left bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 px-5 rounded-lg shadow-sm hover:shadow-md admin-nav-button" data-target="admin-content-add-team">‚ûï Add New Team</button>
                        <button id="open-record-game-modal-btn" class="w-full text-left bg-green-100 hover:bg-green-200 text-green-800 font-bold py-3 px-5 rounded-lg shadow-sm hover:shadow-md">üèÜ Record Game Result</button>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300">
                    <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Manage</h2>
                    <div class="space-y-4">
                        <button class="w-full text-left bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-bold py-3 px-5 rounded-lg shadow-sm hover:shadow-md admin-nav-button" data-target="admin-content-manage-games">‚úèÔ∏è Manage Games</button>
                        <button class="w-full text-left bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-bold py-3 px-5 rounded-lg shadow-sm hover:shadow-md">‚úèÔ∏è Manage Teams</button>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300">
                    <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Tournaments</h2>
                    <div class="space-y-4">
                        <button class="w-full text-left bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-3 px-5 rounded-lg shadow-sm hover:shadow-md admin-nav-button" data-target="admin-content-create-tournament">‚ûï Create New Tournament</button>
                        <button class="w-full text-left bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-3 px-5 rounded-lg shadow-sm hover:shadow-md">‚úèÔ∏è Manage Existing Tournament</button>
                    </div>
                </div>
            </div>

            <div id="admin-content-container">
                <div id="admin-content-add-player" class="admin-content-panel hidden bg-white p-8 rounded-xl shadow-xl max-w-lg mx-auto">
                    <h2 class="text-3xl font-semibold mb-6 text-indigo-700">Add New Player</h2>
                    <form id="add-player-form">
                        <div class="mb-5"> <label for="player-name" class="block text-gray-700 text-sm font-bold mb-2">Player Name:</label> <input type="text" id="player-name" name="player-name" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required> </div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg shadow hover:shadow-md">Add Player</button>
                        <button type="button" class="ml-3 text-gray-600 hover:text-gray-900 font-medium admin-back-button">Cancel</button>
                    </form>
                </div>
                <div id="admin-content-add-team" class="admin-content-panel hidden bg-white p-8 rounded-xl shadow-xl max-w-lg mx-auto">
                     <h2 class="text-3xl font-semibold mb-6 text-indigo-700">Add New Team (for 2v2)</h2>
                     <form id="add-team-form">
                         <div class="mb-5"> <label for="team-name" class="block text-gray-700 text-sm font-bold mb-2">Team Name:</label> <input type="text" id="team-name" name="team-name" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" required> </div>
                         <div class="mb-5"> <label for="team-player1" class="block text-gray-700 text-sm font-bold mb-2">Player 1:</label> <select id="team-player1" name="team-player1" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700" required> <option value="">Select Player</option> </select> </div>
                         <div class="mb-5"> <label for="team-player2" class="block text-gray-700 text-sm font-bold mb-2">Player 2:</label> <select id="team-player2" name="team-player2" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700" required> <option value="">Select Player</option> </select> </div>
                         <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg shadow hover:shadow-md">Add Team</button>
                         <button type="button" class="ml-3 text-gray-600 hover:text-gray-900 font-medium admin-back-button">Cancel</button>
                     </form>
                </div>
                <div id="admin-content-create-tournament" class="admin-content-panel hidden bg-white p-8 rounded-xl shadow-xl max-w-lg mx-auto">
                     <h2 class="text-3xl font-semibold mb-6 text-indigo-700">Create New Tournament</h2>
                     <form id="create-tournament-form">
                         <div class="mb-5"> <label for="tournament-name" class="block text-gray-700 text-sm font-bold mb-2">Tournament Name:</label> <input type="text" id="tournament-name" name="tournament-name" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" required> </div>
                         <div class="mb-5"> <label for="tournament-game-type-select" class="block text-gray-700 text-sm font-bold mb-2">Game Type:</label> <select id="tournament-game-type-select" name="tournament-game-type" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700" required> <option value="">Select Type</option> <option value="1v1">1 vs 1 (General)</option> <option value="2v2">2 vs 2 (General)</option> <option value="ffa">Free-for-All (FFA - General)</option> <option value="team">Team vs Team (General)</option> <option value="pool">Pool</option> <option value="puttpong">PuttPong</option> <option value="golf">Golf</option> <option value="basketball_pickup">Basketball (Pickup)</option> <option value="basketball_horse">Basketball (HORSE)</option> <option value="volleyball_pickup">Volleyball (Pickup)</option> <option value="board_card">Board / Card Game</option> <option value="cornhole">Cornhole</option> <option value="pickleball">Pickleball</option> </select> </div>
                         <div class="mb-5"> <label for="tournament-format" class="block text-gray-700 text-sm font-bold mb-2">Format:</label> <select id="tournament-format" name="tournament-format" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700" required> <option value="">Select Format</option> <option value="single-elim">Single Elimination</option> <option value="double-elim">Double Elimination</option> <option value="round-robin">Round Robin</option> </select> </div>
                         <div class="mb-5"> <label for="tournament-start-date" class="block text-gray-700 text-sm font-bold mb-2">Start Date (Optional):</label> <input type="date" id="tournament-start-date" name="tournament-start-date" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700"> </div>
                         <div class="mb-5"> <label class="block text-gray-700 text-sm font-bold mb-2">Participants:</label> <div id="tournament-participants-list" class="h-40 border rounded-lg p-3 overflow-y-auto bg-gray-50 space-y-2"> <p class="text-gray-500 text-sm">Select Game Type to see participants.</p> </div> <p class="text-xs text-gray-500 mt-1">Select participants. Seeding will be based on current rankings for the selected game type.</p> </div>
                         <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg shadow hover:shadow-md">Create Tournament</button>
                         <button type="button" class="ml-3 text-gray-600 hover:text-gray-900 font-medium admin-back-button">Cancel</button>
                     </form>
                </div>
                <div id="admin-content-manage-games" class="admin-content-panel hidden space-y-8">
                    <div class="flex justify-between items-center border-b-2 border-blue-200 pb-3 mb-6">
                         <h1 class="text-4xl font-bold text-gray-900">Manage Recorded Games</h1>
                         <button class="text-sm text-gray-600 hover:text-gray-900 font-medium admin-back-button">&larr; Back to Admin Panel</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <table class="w-full text-left table-auto text-base">
                            <thead> <tr class="bg-gray-100"> <th class="px-4 py-3">Date</th> <th class="px-4 py-3">Game Type</th> <th class="px-4 py-3">Description</th> <th class="px-4 py-3">Actions</th> </tr> </thead>
                            <tbody id="manage-games-table-body"> </tbody>
                        </table>
                    </div>
                </div>
                </div>
        </section>

    </div>

    <div id="player-info-modal" class="modal-overlay"> </div>
    <div id="record-game-modal" class="modal-overlay"> </div>

    <footer class="text-center text-gray-600 text-base mt-12 mb-6"> &copy; 2025 LeaderBored. Keep it friendly!
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // --- Basic Page Navigation & Admin Simulation ---
        const ADMIN_PASSWORD = "admin";

        // --- DOM Element References (Assigned in initializeApp) ---
        let sections, navLinks, loginForm, loginError, logoutButton,
            recordGameModal, openRecordGameModalBtn, closeRecordGameModalBtn, cancelRecordGameModalBtn, recordGameForm,
            gameTypeSelectModal, subTypeWrapperModal, outcomeWrapperModal, poolModeSelectModal, boardCardScoringSelectModal,
            tournamentGameTypeSelect, tournamentParticipantsList, rankingsGameFilter, rankingTablesContainer,
            playersGrid,
            playerInfoModal, closePlayerModalBtn, manageGamesTableBody,
            adminSection, adminButtonGrid, adminContentContainer, adminNavButtons, adminContentPanels, adminBackButtons;

        // --- Firebase Initialization ---
        let app, db;
        try {
            const firebaseConfig = {
              apiKey: "AIzaSyCF3az8WEAMVpAx5cbp917EUhNM5cRzvwA", // Replace
              authDomain: "leaderbored2.firebaseapp.com", // Replace
              projectId: "leaderbored2", // Replace
              storageBucket: "leaderbored2.appspot.com", // Replace .firebaseapp.com with .appspot.com
              messagingSenderId: "449176616925", // Replace
              appId: "1:449176616925:web:8149e2e8b43a9a72104034", // Replace
              measurementId: "G-8LRFJGV2XY" // Replace (Optional)
            };
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(); // Use compat library
            console.log("[INIT] Firebase Initialized Successfully");
        } catch (error) {
            console.error("[INIT] Error initializing Firebase:", error);
            alert("Could not connect to Firebase. Please check your configuration and console.");
        }

        // Function to assign elements after DOM is loaded
        function assignElements() {
            sections = document.querySelectorAll('.page-section');
            navLinks = document.querySelectorAll('.nav-link');
            loginForm = document.getElementById('login-form');
            loginError = document.getElementById('login-error');
            logoutButton = document.getElementById('logout-button');
            recordGameModal = document.getElementById('record-game-modal');
            openRecordGameModalBtn = document.getElementById('open-record-game-modal-btn');
            closeRecordGameModalBtn = document.getElementById('close-record-game-modal-btn');
            cancelRecordGameModalBtn = document.getElementById('cancel-record-game-modal-btn');
            recordGameForm = document.getElementById('record-game-form');
            gameTypeSelectModal = document.getElementById('game-type-select-modal');
            subTypeWrapperModal = document.getElementById('sub-type-wrapper-modal');
            outcomeWrapperModal = document.getElementById('outcome-wrapper-modal');
            poolModeSelectModal = document.getElementById('pool-game-mode-modal');
            boardCardScoringSelectModal = document.getElementById('board-card-scoring-modal');
            tournamentGameTypeSelect = document.getElementById('tournament-game-type-select');
            tournamentParticipantsList = document.getElementById('tournament-participants-list');
            rankingsGameFilter = document.getElementById('rankings-game-filter');
            rankingTablesContainer = document.getElementById('ranking-tables-container');
            playersGrid = document.querySelector('#players-section .grid');
            playerInfoModal = document.getElementById('player-info-modal');
            closePlayerModalBtn = document.getElementById('close-player-modal-btn');
            manageGamesTableBody = document.getElementById('manage-games-table-body');
            adminSection = document.getElementById('admin-section');
            adminButtonGrid = document.getElementById('admin-button-grid');
            adminContentContainer = document.getElementById('admin-content-container');
            adminNavButtons = document.querySelectorAll('.admin-nav-button');
            adminContentPanels = document.querySelectorAll('.admin-content-panel');
            adminBackButtons = document.querySelectorAll('.admin-back-button');

            // Log if critical elements are missing
            if (!loginForm) console.error("Login form element (#login-form) not found!");
            if (!adminSection) console.error("Admin section element (#admin-section) not found!");
            if (!adminButtonGrid) console.error("Admin button grid element (#admin-button-grid) not found!");
            if (!adminContentContainer) console.error("Admin content container element (#admin-content-container) not found!");
            if (!playersGrid) console.error("Players grid element (#players-grid) not found!");
            if (!playerInfoModal) console.error("Player info modal element (#player-info-modal) not found!");
        }


        // --- Utility Functions ---
        function populateSelect(selectElement, optionsData, valueField = 'id', textField = 'name', prompt = 'Select...') { /* ... */ }
        function populateCheckboxes(containerElement, options, name, valueField = 'id', textField = 'name') { /* ... */ }
        function populateMultiSelectCheckboxes(containerElement, options, name, valueField = 'id', textField = 'name') { /* ... */ }

        // --- Page Section Navigation ---
        function showSection(targetId) {
             if (!sections) { console.error("Sections variable is not assigned yet in showSection"); return; }
             console.log(`[NAV DEBUG] showSection called for: ${targetId}`);
            const cleanTargetId = targetId.startsWith('#') ? targetId.substring(1) : targetId;
            let sectionFound = false;

            // Hide ALL top-level sections first
            sections.forEach(section => {
                if (section && section.id) {
                     section.classList.add('hidden');
                } else {
                    console.warn("Found an element with class 'page-section' but no ID during hide loop.");
                }
            });
            console.log(`[NAV DEBUG] All sections hidden. Attempting to show: ${cleanTargetId}`);

            // Show the target top-level section
            const targetSection = document.getElementById(cleanTargetId);
            if (targetSection) {
                if (targetSection.classList.contains('page-section')) {
                    console.log(`[NAV DEBUG] Showing section: ${targetSection.id}`);
                    targetSection.classList.remove('hidden');
                    sectionFound = true;

                    // If showing the admin section, ensure the button grid is visible and content panels are hidden
                    if (cleanTargetId === 'admin-section') {
                        showAdminOverview(); // Reset admin view to button grid
                    }

                    // Populate dynamic content if needed
                    if (cleanTargetId === 'players-section' && playersGrid) populatePlayersList();
                    if (cleanTargetId === 'rankings-section' && rankingTablesContainer) updateRankingsVisibility();
                    if (cleanTargetId === 'home-section') populateDashboard();

                } else {
                    console.warn(`Element with ID "${cleanTargetId}" found, but it lacks the 'page-section' class.`);
                    sectionFound = false;
                }

            } else {
                 console.warn(`Section with ID "${cleanTargetId}" not found. Showing home.`);
                 const homeSection = document.getElementById('home-section');
                 if (homeSection) {
                     homeSection.classList.remove('hidden');
                     populateDashboard(); // Populate dashboard if showing home
                 } else {
                     console.error("Home section (#home-section) not found as fallback.");
                 }
            }

            if (sectionFound) {
                window.scrollTo(0, 0);
            }
        }

        // --- Admin Panel Navigation ---
        function showAdminContentPanel(targetPanelId) {
            console.log(`[DEBUG] Showing admin content panel: ${targetPanelId}`);
            if (!adminButtonGrid || !adminContentPanels) { console.error("Admin grid or content panels not found"); return; }
            adminButtonGrid.classList.add('hidden');
            adminContentPanels.forEach(panel => panel.classList.add('hidden'));

            const targetPanel = document.getElementById(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.remove('hidden');
                targetPanel.classList.add('active');
                if (targetPanelId === 'admin-content-manage-games' && manageGamesTableBody) {
                    populateManageGamesTable();
                }
                if (targetPanelId === 'admin-content-add-team') {
                    populateAddTeamDropdowns();
                }
                if (targetPanelId === 'admin-content-create-tournament') {
                     populateTournamentParticipantsSelect();
                }
            } else {
                console.warn(`Admin content panel with ID "${targetPanelId}" not found.`);
                showAdminOverview();
            }
        }

        function showAdminOverview() {
            console.log("[DEBUG] Showing admin overview (button grid).");
            if (!adminButtonGrid || !adminContentPanels) { console.error("Admin grid or content panels not found"); return; }
            adminContentPanels.forEach(panel => { panel.classList.add('hidden'); panel.classList.remove('active'); });
            adminButtonGrid.classList.remove('hidden');
        }


        // --- Player List and Modal Functions (Firestore) ---
        async function populatePlayersList() {
             if (!playersGrid) { console.warn("Player grid container (#players-grid) not found."); return; }
             console.log("[PLAYER DEBUG] Populating players list from Firestore...");
             playersGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center">Loading players...</p>';

             try {
                 const playersCollection = db.collection('players');
                 const snapshot = await playersCollection.orderBy('name').get();

                 if (snapshot.empty) {
                     playersGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No players found in database.</p>';
                     console.log("[PLAYER DEBUG] No players found in Firestore.");
                     return;
                 }

                 playersGrid.innerHTML = ''; // Clear loading state
                 snapshot.forEach(doc => {
                     const player = { id: doc.id, ...doc.data() };
                     const div = document.createElement('div');
                     div.className = 'player-entry bg-white p-5 rounded-lg shadow hover:shadow-md cursor-pointer flex items-center space-x-4';
                     div.setAttribute('data-player-id', player.id);
                     // Use iconUrl if present, otherwise generate placeholder
                     const iconLetter = player.name ? player.name.charAt(0).toUpperCase() : '?';
                     const iconUrl = player.iconUrl || `https://placehold.co/48x48/E0E7FF/4F46E5?text=${iconLetter}`;
                     console.log(`[PLAYER DEBUG] Player: ${player.name}, Using icon URL: ${iconUrl}`); // DEBUG
                     div.innerHTML = `
                         <img src="${iconUrl}" alt="Player Icon ${player.name}" class="w-12 h-12 rounded-full flex-shrink-0 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/48x48/cccccc/ffffff?text=?'; this.classList.add('bg-gray-200');"> <span class="font-medium text-lg text-gray-800">${player.name || 'Unnamed Player'}</span> `;
                     playersGrid.appendChild(div);
                 });
                 console.log(`[PLAYER DEBUG] Populated players list with ${snapshot.size} players from Firestore.`);
             } catch (error) {
                 console.error("Error fetching players:", error);
                 playersGrid.innerHTML = '<p class="text-red-500 col-span-full text-center">Error loading players.</p>';
             }
        }

        async function openPlayerModal(playerId) {
            console.log(`[PLAYER MODAL DEBUG] Attempting to open player modal for ID: ${playerId}`);
             if (!playerInfoModal) { console.error("[PLAYER MODAL DEBUG] Player info modal element not found."); return; }
             if (!db) { console.error("[PLAYER MODAL DEBUG] Firestore not initialized."); return; }

             // Ensure modal content exists before trying to populate
             const modalContent = playerInfoModal.querySelector('.modal-content');
             if (!modalContent) { console.error("[PLAYER MODAL DEBUG] Modal content div not found."); return; }

             // Show loading state inside modal
             const modalNameElement = modalContent.querySelector('#modal-player-name');
             const modalStatsElement = modalContent.querySelector('#modal-player-game-stats');
             const modalActivityElement = modalContent.querySelector('#modal-player-recent-activity');
             const modalIconElement = modalContent.querySelector('#modal-player-icon'); // Get icon element

             if(modalNameElement) modalNameElement.textContent = 'Loading...';
             if(modalStatsElement) modalStatsElement.innerHTML = '<p class="text-gray-500">Loading stats...</p>';
             if(modalActivityElement) modalActivityElement.innerHTML = '<li class="text-gray-500">Loading activity...</li>';
             if(modalIconElement) modalIconElement.src = 'https://placehold.co/80x80/E0E7FF/4F46E5?text=?'; // Default loading icon

             playerInfoModal.classList.add('active'); // Show modal overlay immediately
             console.log("[PLAYER MODAL DEBUG] Modal overlay activated."); // DEBUG

             try {
                 const playerDocRef = db.collection('players').doc(playerId);
                 const docSnap = await playerDocRef.get();

                 if (!docSnap.exists) {
                     console.error(`[PLAYER MODAL DEBUG] Player document not found for ID: ${playerId}`);
                     alert(`Error: Could not find details for player ${playerId}`);
                     closePlayerModal();
                     return;
                 }

                 const details = { id: docSnap.id, ...docSnap.data() };
                 console.log("[PLAYER MODAL DEBUG] Fetched player details:", details);

                 playerInfoModal.setAttribute('data-current-player-id', playerId);
                 playerInfoModal.classList.remove('modal-editing');

                 // Safely get modal elements and populate
                 const iconElement = modalContent.querySelector('#modal-player-icon');
                 const nameElement = modalContent.querySelector('#modal-player-name');
                 const nameInputElement = modalContent.querySelector('#modal-edit-player-name-input');
                 const rankElement = modalContent.querySelector('#modal-player-overall-rank');
                 const ratingElement = modalContent.querySelector('#modal-player-overall-rating');
                 const statsElement = modalContent.querySelector('#modal-player-game-stats');
                 const activityElement = modalContent.querySelector('#modal-player-recent-activity');

                 console.log("[PLAYER MODAL DEBUG] Populating modal elements...");

                 const iconLetter = details.name ? details.name.charAt(0).toUpperCase() : '?';
                 // Use iconUrl from DB if available, otherwise generate placeholder
                 const iconSrc = details.iconUrl || `https://placehold.co/80x80/E0E7FF/4F46E5?text=${iconLetter}`;
                 if (iconElement) {
                     iconElement.src = iconSrc;
                     iconElement.alt = `Player Icon ${details.name}`;
                     console.log(`[PLAYER MODAL DEBUG] Set icon src to: ${iconSrc}`);
                 } else { console.warn("Player icon element not found in modal"); }

                 if (nameElement) nameElement.textContent = details.name || 'Unnamed Player'; else { console.warn("Player name display element not found in modal"); }
                 if (nameInputElement) nameInputElement.value = details.name || ''; else { console.warn("Player name input element not found in modal"); }
                 if (rankElement) rankElement.textContent = details.overallRank || 'N/A'; else { console.warn("Player rank element not found in modal"); }
                 if (ratingElement) ratingElement.textContent = details.elo_overall || '1200'; else { console.warn("Player rating element not found in modal"); }
                 // TODO: Fetch and display actual stats and activity from Firestore (requires more complex queries)
                 if (statsElement) statsElement.innerHTML = 'Stats loading not implemented yet.'; else { console.warn("Player stats element not found in modal"); }
                 if (activityElement) activityElement.innerHTML = '<li>Activity loading not implemented yet.</li>'; else { console.warn("Player activity element not found in modal"); }

                 console.log(`[PLAYER MODAL DEBUG] Player modal populated for ${details.name}`);

             } catch (error) {
                  console.error("[PLAYER MODAL DEBUG] Error occurred during openPlayerModal:", error);
                  alert("An error occurred trying to open the player details.");
                  closePlayerModal(); // Close modal on error
             }
        }
        function closePlayerModal() { /* ... */ }

        // --- Record Game Modal Functions ---
        function openRecordGameModal() { /* ... */ }
        function closeRecordGameModal() { /* ... */ }

        // --- Populate Dropdowns from Firestore ---
        async function populateRecordGameDropdowns() { /* ... */ }
         async function populateAddTeamDropdowns() { /* ... */ }
         async function populateTournamentParticipantsSelect() { /* ... */ }


        // --- Admin Management List Population (Firestore) ---
        async function populateManageGamesTable() { /* ... */ }

        // --- Admin Action Handlers (Firestore) ---
        function handleEditGame(gameId) { /* ... */ }
        async function handleDeleteGame(gameId, tableRowElement) { /* ... */ }

        // --- Player Modal Edit Mode Handlers (Firestore) ---
        function togglePlayerModalEdit(editMode) { /* ... */ }
        async function savePlayerChanges() { /* ... */ }
        async function deletePlayer() { /* ... */ }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
             console.log("[DEBUG] Setting up event listeners...");
            // Navigation Links
            if (!navLinks) { console.error("Nav links not found."); return; }
            navLinks.forEach(link => { link.addEventListener('click', handleNavLinkClick); });

            // Admin Login/Logout
            if (loginForm) {
                 console.log("[LOGIN DEBUG] Attaching login form listener in setupEventListeners."); // LOGIN DEBUG
                loginForm.addEventListener('submit', handleLoginFormSubmit); // Use named handler
            } else { console.error("[LOGIN DEBUG] Login form element (#login-form) not found during setupEventListeners."); } // LOGIN DEBUG

            if (logoutButton) logoutButton.addEventListener('click', logout);
            else { console.error("Logout button not found."); }

            // --- Admin Panel Navigation Buttons ---
            if (adminNavButtons) {
                adminNavButtons.forEach(button => {
                    button.addEventListener('click', (event) => {
                        const targetPanelId = event.currentTarget.getAttribute('data-target');
                        if (targetPanelId) {
                            showAdminContentPanel(targetPanelId);
                        } else {
                            console.warn("Admin nav button missing data-target:", event.currentTarget);
                        }
                    });
                });
            } else { console.error("Admin navigation buttons (.admin-nav-button) not found."); }

            // --- Admin Panel Back/Cancel Buttons ---
            if (adminBackButtons) {
                 adminBackButtons.forEach(button => {
                    button.addEventListener('click', showAdminOverview);
                 });
            } else { console.error("Admin back buttons (.admin-back-button) not found."); }


            // --- Record Game Modal ---
            if (openRecordGameModalBtn) openRecordGameModalBtn.addEventListener('click', openRecordGameModal);
            else { console.error("Open record game modal button not found."); }

            if (closeRecordGameModalBtn) closeRecordGameModalBtn.addEventListener('click', closeRecordGameModal);
            else { console.error("Close record game modal button not found."); }

            if (cancelRecordGameModalBtn) cancelRecordGameModalBtn.addEventListener('click', closeRecordGameModal);
            else { console.error("Cancel record game modal button not found."); }

            if (recordGameModal) recordGameModal.addEventListener('click', (event) => { if (event.target === recordGameModal) closeRecordGameModal(); });
            else { console.error("Record game modal overlay not found."); }

            // Dynamic Form Logic (Record Game MODAL)
            if (gameTypeSelectModal) gameTypeSelectModal.addEventListener('change', updateRecordGameFormModal);
            if (poolModeSelectModal) poolModeSelectModal.addEventListener('change', updateRecordGameFormModal);
            if (boardCardScoringSelectModal) boardCardScoringSelectModal.addEventListener('change', updateRecordGameFormModal);

             // Dynamic Form Logic (Create Tournament)
             if (tournamentGameTypeSelect) tournamentGameTypeSelect.addEventListener('change', updateTournamentParticipants);

            // Add Player/Place/Score Buttons (MODAL versions) - Use Event Delegation
            const outcomeWrapperModalElement = document.getElementById('outcome-wrapper-modal');
            if (outcomeWrapperModalElement) {
                outcomeWrapperModalElement.addEventListener('click', (event) => {
                    if (event.target.matches('#add-ffa-place-modal')) {
                        setupAddPlayerButton('add-ffa-place-modal', 'ffa-player-entries-modal');
                    } else if (event.target.matches('#add-golf-player-modal')) {
                         setupAddPlayerButton('add-golf-player-modal', 'golf-player-entries-modal');
                    } else if (event.target.matches('#add-boardgame-player-modal')) {
                         setupAddPlayerButton('add-boardgame-player-modal', 'boardgame-points-entries-modal');
                    }
                });
            }

            // Rankings Filter
            if (rankingsGameFilter) rankingsGameFilter.addEventListener('change', updateRankingsVisibility);

            // Player Modal Close & Edit Buttons
            if (closePlayerModalBtn) closePlayerModalBtn.addEventListener('click', closePlayerModal);
            if (playerInfoModal) {
                playerInfoModal.addEventListener('click', (event) => {
                    console.log("[PLAYER MODAL DEBUG] Click inside player info modal detected. Target:", event.target); // DEBUG
                    if (event.target === playerInfoModal) {
                        console.log("[PLAYER MODAL DEBUG] Clicked on overlay, closing player modal."); // DEBUG
                        closePlayerModal(); // Close on overlay click
                    } else if (event.target.matches('#edit-player-modal-btn')) {
                        console.log("[PLAYER MODAL DEBUG] Edit player button clicked."); // DEBUG
                        togglePlayerModalEdit(true); // Enter edit mode
                    } else if (event.target.matches('#save-player-changes-btn')) {
                        console.log("[PLAYER MODAL DEBUG] Save player changes button clicked."); // DEBUG
                        savePlayerChanges(); // Save changes
                    } else if (event.target.matches('#cancel-player-edit-btn')) {
                        console.log("[PLAYER MODAL DEBUG] Cancel player edit button clicked."); // DEBUG
                        togglePlayerModalEdit(false); // Cancel edit mode
                    } else if (event.target.matches('#delete-player-btn')) {
                        console.log("[PLAYER MODAL DEBUG] Delete player button clicked."); // DEBUG
                        deletePlayer(); // Delete player
                    }
                });
            }

            // Form Submission Handlers
            handleFormSubmit('add-player-form', 'Player Added!');
            handleFormSubmit('add-team-form', 'Team Added!');
            handleFormSubmit('record-game-form', 'Game Recorded!'); // Handles the modal form
            handleFormSubmit('create-tournament-form', 'Tournament Created!');
            // Removed listener for edit-player-form as it's deleted

            // --- Event Delegation for Dynamic Buttons ---
            // Players Page - Open Modal
            if (playersGrid) {
                 console.log("[DEBUG] Attaching player grid click listener."); // DEBUG
                playersGrid.addEventListener('click', (event) => {
                    console.log("[DEBUG] Click detected inside players grid."); // DEBUG
                    const playerEntry = event.target.closest('.player-entry');
                    if (playerEntry) {
                        console.log("[DEBUG] Click target is a player entry."); // DEBUG
                        const playerId = playerEntry.getAttribute('data-player-id');
                        if (playerId) {
                            console.log(`[DEBUG] Player ID found: ${playerId}. Opening modal.`); // DEBUG
                            openPlayerModal(playerId);
                        } else {
                            console.warn("[DEBUG] Player entry clicked, but no data-player-id found."); // DEBUG
                        }
                    } else {
                         console.log("[DEBUG] Click target is NOT a player entry."); // DEBUG
                    }
                });
            } else { console.error("Players grid not found for event delegation."); }

            // Manage Games Page - Edit/Delete
            if (manageGamesTableBody) {
                manageGamesTableBody.addEventListener('click', (event) => {
                    const targetButton = event.target;
                    const gameRow = targetButton.closest('tr');
                    if (!gameRow) return;
                    const gameId = gameRow.getAttribute('data-game-id');
                    if (!gameId) return;

                    if (targetButton.classList.contains('edit-game-btn')) {
                        handleEditGame(gameId);
                    } else if (targetButton.classList.contains('delete-game-btn')) {
                        handleDeleteGame(gameId, gameRow);
                    }
                });
            }

             console.log("Event listeners setup complete.");
        }

        // --- Specific Event Handlers ---
        function handleNavLinkClick(event) {
            const targetId = event.currentTarget.getAttribute('data-target');
            if (targetId) {
                event.preventDefault();
                console.log(`[DEBUG] Navigating to section: ${targetId}`);
                showSection(targetId);
            } else { console.warn("Nav link missing data-target:", event.currentTarget); }
        }

        function handleLoginFormSubmit(event) {
            // This function is now called directly by the event listener in setupEventListeners
            alert("[LOGIN DEBUG] Login form submitted!"); // Alert to confirm event fired
            console.log("[LOGIN DEBUG] handleLoginFormSubmit called."); // Specific log
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                const passwordValue = passwordInput.value;
                console.log(`[LOGIN DEBUG] Password value from input: "${passwordValue}"`); // Specific log
                login(passwordValue); // Call login function
            } else { console.error("[LOGIN DEBUG] Password input field not found inside handleLoginFormSubmit."); } // Specific log
        }


        // --- Admin Login/Logout Logic ---
        function checkLoginState() {
             const isLoggedIn = sessionStorage.getItem('isAdminLoggedIn') === 'true';
             console.log(`[LOGIN DEBUG] checkLoginState: isLoggedIn = ${isLoggedIn}`); // DEBUG
             if (isLoggedIn) {
                 document.body.classList.add('admin-logged-in');
                 console.log("[LOGIN DEBUG] checkLoginState: Added admin-logged-in class to body."); // DEBUG
             } else {
                 document.body.classList.remove('admin-logged-in');
                 console.log("[LOGIN DEBUG] checkLoginState: Removed admin-logged-in class from body."); // DEBUG
                 if(sections) { // Ensure sections exist before looping
                    sections.forEach(section => {
                        if (section.classList.contains('admin-only') && !section.classList.contains('hidden')) {
                           section.classList.add('hidden');
                           console.log(`[LOGIN DEBUG] checkLoginState: Hiding admin-only section: ${section.id}`); // DEBUG
                        }
                    });
                 }
             }
             return isLoggedIn;
        }
        function login(password) {
            alert(`[LOGIN DEBUG] Inside login function. Comparing "${password}" with "${ADMIN_PASSWORD}"`); // Alert to confirm function called
            console.log(`[LOGIN DEBUG] Inside login function. Comparing "${password}" with "${ADMIN_PASSWORD}"`); // Specific log
            const localLoginError = document.getElementById('login-error');
            if (password === ADMIN_PASSWORD) {
                alert("[LOGIN DEBUG] Password MATCHES!"); // Alert on success
                console.log("[LOGIN DEBUG] Password MATCHES. Setting session storage and updating UI."); // Specific log
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                checkLoginState(); // Apply logged-in styles FIRST
                showSection('admin-section'); // THEN navigate to admin panel

                if(localLoginError) localLoginError.classList.add('hidden');
                const passwordInput = document.getElementById('password');
                if(passwordInput) passwordInput.value = '';
                console.log("[LOGIN DEBUG] Admin login successful."); // Specific log
            } else {
                alert("[LOGIN DEBUG] Password DOES NOT MATCH."); // Alert on failure
                console.log("[LOGIN DEBUG] Password DOES NOT MATCH."); // Specific log
                if(localLoginError) localLoginError.classList.remove('hidden');
                 console.log("[LOGIN DEBUG] Admin login failed: Incorrect password."); // Specific log
            }
        }
        function logout() { /* ... */ }

        // --- Dynamic Form Logic (MODAL version) ---
        function updateRecordGameFormModal() { /* ... */ }
        function updateTournamentParticipants() { /* ... */ }

        // --- Add Player/Place/Score Button Logic ---
        function setupAddPlayerButton(buttonId, containerId) { /* ... */ }

        // --- Rankings Filter Logic ---
        function updateRankingsVisibility() { /* ... */ }

        // --- Form Submission Handlers (Firestore) ---
        async function handleFormSubmit(formId, successMessage) {
             const form = document.getElementById(formId);
             if (form && formId !== 'login-form') {
                 form.addEventListener('submit', async (event) => { // Make handler async
                     event.preventDefault();
                     let isValid = true;
                     form.querySelectorAll('select[required], input[required]').forEach(field => {
                         if (!field.value) { isValid = false; field.classList.add('border-red-500'); }
                         else { field.classList.remove('border-red-500'); }
                     });
                     if (!isValid) { alert("Please fill out all required fields."); return; }

                     const formData = Object.fromEntries(new FormData(form));
                     console.log(`Form submitted: ${formId}`, formData);

                     // --- Save Data to Firestore ---
                     if (!db) { alert("Database connection error."); return; }

                     try {
                         if (formId === 'add-player-form') {
                             const newPlayerName = formData['player-name'];
                             if (newPlayerName) {
                                 const docRef = await db.collection('players').add({
                                     name: newPlayerName,
                                     elo_overall: 1200, // Default starting Elo
                                     date_created: firebase.firestore.FieldValue.serverTimestamp() // Use server timestamp
                                     // Add other fields like iconUrl if you add an input for it
                                 });
                                 console.log("[FIRESTORE] Added new player with ID:", docRef.id);
                                 // Optionally refresh players list immediately if needed
                                 // if (playersGrid && !playersGrid.closest('.page-section.hidden')) {
                                 //     populatePlayersList();
                                 // }
                             }
                             showAdminOverview(); // Go back to admin overview after adding
                         } else if (formId === 'record-game-form') {
                             // Construct game data object (needs more detail based on form)
                             const gameData = {
                                 game_type: formData['game-type'],
                                 date_played: firebase.firestore.FieldValue.serverTimestamp(),
                                 // --- TODO: Extract participants, outcome, score based on game type ---
                                 participants: [formData['winner_player'], formData['loser_player']].filter(p => p), // Simplified example
                                 outcome: formData['is_draw'] ? 'Draw' : 'Win/Loss', // Simplified
                                 score: formData['score'] || null
                             };
                             const docRef = await db.collection('games').add(gameData);
                             console.log("[FIRESTORE] Recorded new game with ID:", docRef.id);
                             closeRecordGameModal(); // Close the modal
                         } else if (formId === 'add-team-form') {
                             // TODO: Add logic to save team to Firestore
                             console.log("[DEBUG] Add Team form submitted (Firestore save not implemented).");
                             showAdminOverview(); // Go back to admin overview
                         } else if (formId === 'create-tournament-form') {
                             // TODO: Add logic to save tournament to Firestore
                             console.log("[DEBUG] Create Tournament form submitted (Firestore save not implemented).");
                             showAdminOverview(); // Go back to admin overview
                         }

                         alert(`${successMessage} (Data saved to Firebase)`);
                         form.reset();

                         // Reset dynamic sections if applicable (only needed for modal now)
                         if (formId === 'record-game-form') updateRecordGameFormModal();

                     } catch (error) {
                         console.error("Error saving data to Firestore:", error);
                         alert(`Error saving data: ${error.message}. See console for details.`);
                     }
                 });
             } else if (formId !== 'login-form') {
                 console.warn(`Form with ID "${formId}" not found for submission handling.`);
             }
        }

        // --- Initialization ---
        // Function to assign elements after DOM is loaded
        function assignElements() {
            sections = document.querySelectorAll('.page-section');
            navLinks = document.querySelectorAll('.nav-link');
            loginForm = document.getElementById('login-form');
            loginError = document.getElementById('login-error');
            logoutButton = document.getElementById('logout-button');
            // cancelAdminButtons = document.querySelectorAll('.cancel-admin-action'); // Replaced by adminBackButtons
            recordGameModal = document.getElementById('record-game-modal');
            openRecordGameModalBtn = document.getElementById('open-record-game-modal-btn');
            closeRecordGameModalBtn = document.getElementById('close-record-game-modal-btn');
            cancelRecordGameModalBtn = document.getElementById('cancel-record-game-modal-btn');
            recordGameForm = document.getElementById('record-game-form');
            gameTypeSelectModal = document.getElementById('game-type-select-modal');
            subTypeWrapperModal = document.getElementById('sub-type-wrapper-modal');
            outcomeWrapperModal = document.getElementById('outcome-wrapper-modal');
            poolModeSelectModal = document.getElementById('pool-game-mode-modal');
            boardCardScoringSelectModal = document.getElementById('board-card-scoring-modal');
            tournamentGameTypeSelect = document.getElementById('tournament-game-type-select');
            tournamentParticipantsList = document.getElementById('tournament-participants-list');
            rankingsGameFilter = document.getElementById('rankings-game-filter');
            rankingTablesContainer = document.getElementById('ranking-tables-container');
            playersGrid = document.querySelector('#players-section .grid'); // Assign playersGrid
            playerInfoModal = document.getElementById('player-info-modal');
            closePlayerModalBtn = document.getElementById('close-player-modal-btn');
            manageGamesTableBody = document.getElementById('manage-games-table-body');
            // New admin panel elements
            adminSection = document.getElementById('admin-section');
            adminButtonGrid = document.getElementById('admin-button-grid');
            adminContentContainer = document.getElementById('admin-content-container');
            adminNavButtons = document.querySelectorAll('.admin-nav-button'); // Buttons in the grid
            adminContentPanels = document.querySelectorAll('.admin-content-panel'); // The content divs
            adminBackButtons = document.querySelectorAll('.admin-back-button'); // Back/Cancel buttons inside panels

            // Log if critical elements are missing
            if (!loginForm) console.error("Login form element (#login-form) not found!");
            if (!adminSection) console.error("Admin section element (#admin-section) not found!");
            if (!adminButtonGrid) console.error("Admin button grid element (#admin-button-grid) not found!");
            if (!adminContentContainer) console.error("Admin content container element (#admin-content-container) not found!");
        }

        function initializeApp() {
             try {
                console.log("[DEBUG] Initializing App..."); // DEBUG
                assignElements();
                console.log("[DEBUG] Elements assigned."); // DEBUG

                if (!db) {
                    console.error("Firebase DB not initialized. App cannot function fully.");
                    return; // Stop initialization if DB failed
                }

                const isLoggedIn = checkLoginState();
                console.log(`[DEBUG] Initial login state: ${isLoggedIn}`); // DEBUG

                setupEventListeners(); // Setup all event listeners AFTER elements are assigned

                // Determine initial section
                const initialHash = window.location.hash;
                let navigatedByHash = false;
                if (initialHash && initialHash !== '#') {
                    const targetLink = document.querySelector(`.nav-link[href="${initialHash}"]`);
                    if (targetLink) {
                         const targetId = targetLink.getAttribute('data-target');
                         const targetSection = document.getElementById(targetId);
                         const isAdminOnly = targetSection?.classList.contains('admin-only');
                         if (targetId && targetSection && (!isAdminOnly || isLoggedIn)) {
                            console.log(`Navigating to initial section from hash: ${targetId}`);
                            showSection(targetId);
                            navigatedByHash = true;
                         } else if (targetId && targetSection && isAdminOnly && !isLoggedIn) {
                             console.log("Blocked hash nav to admin section.");
                         }
                    }
                }
                if (!navigatedByHash) {
                     const visibleSection = document.querySelector('.page-section:not(.hidden)');
                     if (!visibleSection || (visibleSection?.classList.contains('admin-only') && !isLoggedIn)) {
                         console.log("No initial section visible/allowed or from hash, showing home.");
                         showSection('home-section');
                     } else if (visibleSection) {
                         console.log(`Browser restored visible section: ${visibleSection.id}`);
                        if (visibleSection.id === 'players-section') populatePlayersList();
                        if (visibleSection.id === 'rankings-section') updateRankingsVisibility();
                        if (visibleSection.id === 'admin-manage-games-section') populateManageGamesTable();
                        if (visibleSection.id === 'admin-section') showAdminOverview();
                     } else {
                         console.log("No visible section found, defaulting to home.");
                         showSection('home-section');
                     }
                }

                updateRecordGameFormModal(); // Set initial state for modal form sections
                console.log("[DEBUG] App Initialized Successfully."); // DEBUG
             } catch (error) {
                 console.error("Error during app initialization:", error);
                 alert("An error occurred while initializing the application. Please check the console.");
             }
        }

        // --- Run Initialization ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>
